<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla de Afiliados - Gestor Simplificado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* CONSTANTES DE COLOR */
        :root {
            --stm-purple: #5A377B; 
            --stm-teal: #34B3C5;   
            --stm-red: #dc3545;    
            --stm-indigo: #4f46e5; 
            --stm-dark-purple: #492a63;
        }

        /* ------------------------------------------------------------------- */
        /* ESTILOS DE GESTOR Y RESPONSIVENESS */
        /* ------------------------------------------------------------------- */
        body {
            font-family: 'Roboto', sans-serif; 
            background-color: #f3f4f6; 
        }

        .main-container {
            border-top: 4px solid var(--stm-indigo);
            max-width: 1100px;
            margin: 30px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header-main-flex {
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 10px; 
        }

        .header-logo-title {
            display: flex;
            align-items: center;
            flex-grow: 1; 
            max-width: calc(100% - 150px); 
        }

        .header-logo-title img {
            max-width: 50px; 
            height: auto; 
            border-radius: 50%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-right: 12px; 
            flex-shrink: 0;
        }

        .header-title-text {
            display: flex;
            flex-direction: column;
            line-height: 1; 
        }
        
        .header-title-text .subtitle {
            font-size: 1rem;
            font-weight: 400;
            color: #4b5563; 
            margin: 0;
        }
        
        .header-title-text .title {
            font-size: 1.5rem; 
            font-weight: 700;
            color: var(--stm-purple); 
            margin: 0;
            white-space: nowrap; 
        }
        
        .btn-dashboard {
            background-color: var(--stm-purple); 
            border-color: var(--stm-dark-purple); 
            color: #ffffff;
            font-weight: 600;
            padding: 8px 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(90, 55, 123, 0.4);
            transition: all 0.2s ease-in-out;
            text-decoration: none; 
            white-space: nowrap; 
            flex-shrink: 0;
        }
        .btn-dashboard:hover,
        .btn-dashboard:focus {
            background-color: var(--stm-dark-purple); 
            border-color: var(--stm-dark-purple);
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        @media (max-width: 767.98px) {
            .main-container {
                padding: 15px;
                margin: 15px auto;
            }
            .header-main-flex {
                flex-direction: row; 
                justify-content: space-between;
                align-items: flex-start;
            }
            .header-logo-title {
                max-width: 100%;
                flex-grow: 1;
            }
            .header-title-text .subtitle {
                font-size: 0.9rem;
            }
            .header-title-text .title {
                font-size: 1.3rem; 
            }
        }

        .table-container {
            border-radius: 8px;
            overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto; 
        }
        
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af; 
            border-radius: 10px;
        }
        
        tr.cursor-pointer:hover {
            background-color: #eef2ff !important; 
        }
        
        #data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* ------------------------------------------------------------------- */
        /* ESTILOS DE LA CREDENCIAL QR (Copiados EXACTAMENTE de credencial_qr.html) */
        /* ------------------------------------------------------------------- */
        .logo-stm-img {
            height: 60px;
            width: auto;
        }

        .card-container {
            font-family: 'Inter', sans-serif; 
            width: 340px; 
            height: 215px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #ffffff; 
            border: 1px solid #e5e7eb; 
            border-radius: 10px;
            overflow: hidden; 
        }
        
        @media print {
            body * {
                visibility: hidden;
            }

            #credential-modal,
            #credential-modal * {
                visibility: visible;
            }

            #credential-modal {
                position: absolute;
                left: 0;
                top: 0;
                display: block !important;
                background: none;
                padding: 0;
            }

            #credential-modal .bg-white {
                background-color: transparent !important;
                box-shadow: none;
                padding: 0;
            }

            #credential-modal .card-container {
                position: absolute;
                left: 0;
                top: 0;
                box-shadow: none;
                border: 1px solid #ccc; 
                margin: 0;
            }
            
            .print-btn-container,
            .close-btn,
            .modal-title {
                display: none !important;
            }
        }
        /* ------------------------------------------------------------------- */
        /* FIN ESTILOS DE LA CREDENCIAL QR */
        /* ------------------------------------------------------------------- */
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="main-container"> 
        
        <div class="header-main-flex">
            
            <div class="header-logo-title">
                <img src="logo_STM.png" alt="Logo Sindicato de Trabajadores Municipales">
                
                <div class="header-title-text">
                    <p class="subtitle">Gestor de</p>
                    <h1 class="title">Afiliaciones</h1>
                </div>
            </div>

            <a href="dashboard.html" class="btn-dashboard">
                <i class="fas fa-chart-line me-2"></i> Tablero de mando
            </a>
            
        </div>
        
        <p class="text-gray-600 mb-6 sm:mb-8 border-b pb-4">
            Datos del afiliado.
        </p>

        <div id="messages" class="mt-6 p-4 bg-yellow-100 text-yellow-800 rounded-lg hidden">
            </div>

        <div id="loading" class="text-center p-8 text-lg font-semibold text-blue-600">
            Cargando datos... 
        </div>

        <div id="table-container" class="table-container hidden"> 
            <table id="data-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-600 text-white sticky top-0">
                    </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>

    </div> 
    
    <div id="detail-card" class="max-w-7xl mx-auto mt-8 mb-6 hidden">
    </div>

    <div id="credential-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-center hidden p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl relative max-w-sm w-full" style="max-width: 400px;">
            <h3 class="modal-title text-xl font-bold text-gray-800 mb-4 border-b pb-2">Credencial Digital del Afiliado</h3>
            
            <div id="credential-card-container" class="flex justify-center">
                </div>
            
            <div class="print-btn-container mt-4 flex flex-col space-y-2">
                <button onclick="window.print()" class="print-btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out">
                    <i class="fas fa-print mr-2"></i> Imprimir / Guardar PDF
                </button>
                <button onclick="document.getElementById('credential-modal').classList.add('hidden'); document.getElementById('credential-modal').classList.remove('flex')" class="close-btn inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    <script>
        // --- INSTRUCCIONES IMPORTANTES PARA EL USUARIO ARGENTINO ---
        // 1. Reemplaz√° 'TU_SPREADSHEET_ID' con el ID real de tu planilla (lo sac√°s de la URL).
        // 2. Reemplaz√° '0' por el GID de la hoja que quer√©s mostrar (la primera hoja es 0, si es otra, cambialo).
        // 3. ¬°MUY IMPORTANTE! Ten√©s que hacer p√∫blica la planilla: 
        //    'Compartir' -> 'Acceso general' -> 'Cualquier persona con el enlace' -> 'Lector'.
        
        // ¬°ACTUALIZ√Å ESTOS VALORES!
        const SPREADSHEET_ID = '1OZnWCvh9NpBaoZndAV1IPPqtNWgQnv8GMh6J2-l3wZo'; 
        const GID = '1600259031'; 
        
        // URL para la API de Google Visualization que devuelve JSON
        const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

        // Nombres de TODAS las columnas, el orden es clave.
        const ALL_COLUMN_HEADINGS = [
            'ID', 'Nombre y Apellido', 'Legajo', 'DNI', 'F. Nac.', 
            'Nacionalidad', 'Est. Civil', 'Domicilio', 'Tel√©fono', 'Email', 
            'Ente Sec.', 'Dependencia', 'Cargo', 'Planta', 'Email PDF', 'Enviado'
        ];
        
        // Columnas a mostrar en la tabla (solo las claves)
        const VISIBLE_COLUMN_HEADINGS = ['Nombre y Apellido', 'Legajo', 'Tel√©fono'];
        
        // √çndices de las columnas visibles en la tabla
        const VISIBLE_COLUMN_INDICES = VISIBLE_COLUMN_HEADINGS.map(
            name => ALL_COLUMN_HEADINGS.indexOf(name)
        );

        // --- ETIQUETAS PERSONALIZADAS PARA EL DETALLE SOLICITADAS PREVIAMENTE ---
        const DETAIL_LABELS_MAP = {
            'DNI': 'DNI',
            'F. Nac.': 'Fecha de Nacimiento',
            'Nacionalidad': 'Nacionalidad',
            'Est. Civil': 'Estado Civil',
            'Domicilio': 'Domicilio',
            'Email': 'Correo elecr√≥nico', 
            'Ente Sec.': 'Ente/Secretaria',
            'Dependencia': 'Dependencia',
            'Cargo': 'Cargo',
            'Planta': 'Planta',
        };

        // Columnas que NO queremos que aparezcan en la tarjeta de detalle
        const EXCLUDE_FROM_DETAIL = ['ID', 'Nombre y Apellido', 'Legajo', 'Tel√©fono', 'Email PDF', 'Enviado'];


        const loadingDiv = document.getElementById('loading');
        const tableContainerDiv = document.getElementById('table-container');
        const dataTable = document.getElementById('data-table');
        const messagesDiv = document.getElementById('messages');
        const detailCardDiv = document.getElementById('detail-card');
        
        let allAffiliateData = [];
        
        
        // =========================================================================
        // === FUNCIONES DE AUTENTICACI√ìN Y SEGURIDAD ==============================
        // =========================================================================
        
        function checkAuthentication() {
            const isAuthenticated = localStorage.getItem('isAuthenticatedSTM') === 'true';
            if (!isAuthenticated) {
                window.location.href = 'index.html';
                return false; 
            }
            return true;
        }

        // =========================================================================
        // === FIN FUNCIONES DE AUTENTICACI√ìN Y SEGURIDAD ==========================
        // =========================================================================
        

        /**
         * Muestra un mensaje de error en la interfaz.
         */
        function displayMessage(msg) {
            messagesDiv.textContent = msg;
            messagesDiv.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800');
            messagesDiv.classList.add('bg-red-100', 'text-red-800');
        }
        
        /**
         * Convierte el formato de fecha de Google Sheets a un formato m√°s legible (DD/MM/YYYY).
         */
        function formatGoogleDate(googleDateStr) {
            if (typeof googleDateStr === 'string' && googleDateStr.startsWith('Date(')) {
                const match = googleDateStr.match(/Date\((\d+),(\d+),(\d+)\)/);
                if (match) {
                    const year = match[1];
                    const month = parseInt(match[2], 10) + 1; 
                    const day = match[3];

                    const formattedMonth = String(month).padStart(2, '0');
                    const formattedDay = String(day).padStart(2, '0');

                    return `${formattedDay}/${formattedMonth}/${year}`;
                }
            }
            return googleDateStr;
        }
        
        /**
         * Genera y muestra la credencial QR del afiliado en un modal, usando el dise√±o de credencial_qr.html.
         */
        function handleCredentialGeneration(rowIndex) {
            const affiliate = allAffiliateData[rowIndex];
            if (!affiliate) return;

            // 1. Obtener datos clave
            const nombreCompleto = affiliate['Nombre y Apellido'] || 'AFILIADO STM';
            const legajo = affiliate['Legajo'] || 'N/A';
            const dni = affiliate['DNI'] || 'N/A';
            
            const logoSrc = "logo_STM.png"; 

            // 2. Generar el contenido del QR (Copiado de credencial_qr.html)
            const qrContent = `SINDICATO DE TRABAJADORES MUNICIPALES MGP
Legajo: ${legajo}
Afiliado: ${nombreCompleto.toUpperCase()}
DNI: ${dni}`; 

            // 3. Crear el HTML de la credencial (Copiado de credencial_qr.html y adaptado para inyecci√≥n de datos)
            const cardHtml = `
                <div class="card-container">

                    <div class="p-3 border-b border-gray-200 flex justify-between items-start bg-gray-50">
                        <div>
                            <p class="text-lg font-bold leading-tight text-gray-900">Sindicato de Trabajadores</p>
                            <p class="text-lg font-bold leading-tight text-gray-900">Municipales</p>
                            <p class="text-xs text-gray-600">de Gral. Pueyrred√≥n</p>
                        </div>
                        <img src="${logoSrc}" alt="Logo STM" class="logo-stm-img">
                    </div>

                    <div class="flex p-3 space-x-3 border-b border-gray-300">
                        <div id="qrcode-target" class="w-24 h-24 flex-shrink-0 border p-1 rounded-sm">
                            </div>

                        <div class="flex-grow overflow-hidden">
                            <p class="text-xs font-semibold text-gray-700 mb-1">Legajo N¬∞ <span id="legajo-output"
                                    class="text-gray-900 text-sm font-bold">${legajo}</span></p>
                            <p id="nombre-output"
                                class="text-sm sm:text-lg font-extrabold leading-tight text-gray-900 uppercase truncate">
                                ${nombreCompleto.toUpperCase()}</p>
                            <p class="text-sm font-semibold text-gray-700 mt-1">DNI <span id="dni-output"
                                    class="text-gray-900 text-base font-bold">${dni}</span></p>
                        </div>
                    </div>

                    <div class="bg-gray-100 p-2 text-center">
                        <p class="text-sm font-extrabold text-blue-800 tracking-wide mb-1">CREDENCIAL DE AFILIADO</p>
                        <p class="text-xs text-gray-700 leading-tight">Moreno 4359 - (223) 4723756 - Mar del Plata - Pcia.
                            Bs. As.</p>
                        <p class="text-xs italic text-gray-800 leading-tight mt-0.5">Carece de validez si no se exhibe con
                            DNI</p>
                    </div>
                </div>
            `;

            const cardContainer = document.getElementById('credential-card-container');
            cardContainer.innerHTML = cardHtml; // Inyectar el HTML de la credencial

            // 4. Generar el C√≥digo QR
            const qrDiv = document.getElementById('qrcode-target'); 
            
            new QRCode(qrDiv, {
                text: qrContent,
                width: 85,
                height: 85,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // 5. Mostrar el modal
            document.getElementById('credential-modal').classList.remove('hidden');
            document.getElementById('credential-modal').classList.add('flex'); // Usar flex para centrar
        }
        
        /**
         * Muestra el card de detalles del afiliado con el bot√≥n de llamada y el nuevo bot√≥n QR.
         */
        function showDetailCard(rowIndex) {
            const affiliate = allAffiliateData[rowIndex];
            if (!affiliate) return;

            const name = affiliate[ALL_COLUMN_HEADINGS[1]] || 'Afiliado Desconocido'; 
            const email = affiliate[ALL_COLUMN_HEADINGS[9]] || ''; 
            const phone = affiliate[ALL_COLUMN_HEADINGS[8]] || ''; 
            
            const cleanPhone = phone.replace(/[^\d]/g, '');

            let cardContent = `
                <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg shadow-xl mx-auto">
                    <h3 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">
                        Detalles de ${name} üìã
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3 text-gray-700">
            `;

            // Generar el cuerpo del Card con el resto de la informaci√≥n
            ALL_COLUMN_HEADINGS.forEach((heading) => {
                
                if (EXCLUDE_FROM_DETAIL.includes(heading)) {
                    return; 
                }
                
                let value = affiliate[heading] || 'N/A';
                
                if (heading === 'F. Nac.' && value !== 'N/A') {
                   value = formatGoogleDate(value);
                }
                
                const label = DETAIL_LABELS_MAP[heading] || heading; 

                cardContent += `
                    <p>
                        <strong class="font-semibold text-gray-900">${label}:</strong> ${value}
                    </p>
                `;
            });

            // --- BLOQUE DE BOTONES (incluye el bot√≥n de Llamar solo para m√≥vil: sm:hidden) ---
            cardContent += `
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                        
                        <button onclick="handleCredentialGeneration(${rowIndex})"
                           class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                            üí≥ Generar Credencial QR
                        </button>
                        
                        <a href="tel:${cleanPhone}" 
                           class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out sm:hidden ${!cleanPhone ? 'opacity-50 cursor-not-allowed' : ''}"
                           ${!cleanPhone ? 'disabled aria-disabled="true"' : ''}>
                            üì± Llamar
                        </a>

                        <a href="mailto:${email}" 
                           class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out ${!email ? 'opacity-50 cursor-not-allowed' : ''}"
                           ${!email ? 'disabled aria-disabled="true"' : ''}>
                            ‚úâÔ∏è Enviar Email
                        </a>
                    </div>
                    ${!cleanPhone && !email ? '<p class="mt-4 text-sm text-red-500 text-center">No se encontraron datos de contacto (tel√©fono o email).</p>' : ''}
                </div>
            `;

            detailCardDiv.innerHTML = cardContent;
            detailCardDiv.classList.remove('hidden');
        }

        /**
         * Procesa y muestra los datos de la hoja de c√°lculo.
         */
        function renderTable(dataJson) {
            try {
                const table = dataJson.table;
                if (!table || !table.rows || table.rows.length === 0) {
                    displayMessage('¬°No se encontraron datos, che! Revis√° si el ID y el GID est√°n bien o si la planilla tiene contenido.');
                    return;
                }

                const thead = dataTable.querySelector('thead');
                const tbody = dataTable.querySelector('tbody');
                thead.innerHTML = '';
                tbody.innerHTML = '';
                
                allAffiliateData = [];

                // 1. Crear encabezados (<thead>) con solo las columnas visibles
                let headerRow = '<tr>';
                VISIBLE_COLUMN_HEADINGS.forEach(header => {
                    headerRow += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">${header}</th>`;
                });
                headerRow += '</tr>';
                thead.innerHTML = headerRow;

                // 2. Llenar filas (<tbody>)
                table.rows.forEach((row, rowIndex) => {
                    
                    let rowData = {};
                    let rowHtml = '';
                    
                    for (let i = 0; i < ALL_COLUMN_HEADINGS.length; i++) {
                        const cell = row.c[i];
                        let cellValue = cell ? (cell.f || cell.v) : ''; 

                        if (i === 4 && cellValue) {
                           cellValue = formatGoogleDate(cellValue);
                        }
                        
                        rowData[ALL_COLUMN_HEADINGS[i]] = cellValue;

                        if (VISIBLE_COLUMN_INDICES.includes(i)) {
                            rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${cellValue}</td>`;
                        }
                    }
                    
                    allAffiliateData.push(rowData);

                    const rowElement = document.createElement('tr');
                    rowElement.className = 'cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out';
                    rowElement.innerHTML = rowHtml;
                    
                    rowElement.addEventListener('click', () => showDetailCard(rowIndex)); 
                    tbody.appendChild(rowElement);
                });

                loadingDiv.classList.add('hidden');
                tableContainerDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Error al renderizar la tabla:', error);
                displayMessage('¬°Uy! Hubo un quilombo al procesar los datos. Revis√° la consola para m√°s detalles.');
            }
        }

        /**
         * Inicializa la aplicaci√≥n: obtiene los datos de la hoja de c√°lculo.
         */
        async function initializeApp() {
            if (!checkAuthentication()) {
                return; 
            }
            
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                const text = await response.text();
                
                const jsonStr = text.substring(
                    text.indexOf('{'), 
                    text.lastIndexOf('}') + 1
                );
                
                const data = JSON.parse(jsonStr);

                if (data.status === 'ok') {
                    renderTable(data);
                } else {
                    console.error('Error de la API de Google Sheets:', data.errors);
                    displayMessage(`¬°Fall√≥ la carga! Puede ser un problema de permisos. Asegurate que la hoja es P√öBLICA. Detalle: ${data.errors[0].message}`);
                }

            } catch (error) {
                console.error('Error al obtener los datos:', error);
                displayMessage(`¬°No pudimos conectar con la planilla, che! Revis√° si el ID (${SPREADSHEET_ID}) y el GID (${GID}) est√°n bien y si la hoja est√° compartida como P√öBLICA. Detalles t√©cnicos: ${error.message}`);
            } finally {
                if (loadingDiv && !tableContainerDiv.classList.contains('hidden')) {
                    loadingDiv.classList.add('hidden');
                }
            }
        }
        
        initializeApp();
    </script>
</body>
</html>