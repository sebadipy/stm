<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top"> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Usuarios - STM</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CONSTANTES DE COLOR MIGRADO DE gestor_convenios.html */
        :root {
            --stm-purple: #5A377B; /* P√∫rpura principal (Guardar) */
            --stm-teal: #34B3C5;   /* Turquesa (Crear) */
            --stm-red: #dc3545;    /* Rojo (Eliminar) */
            --stm-indigo: #4f46e5; /* √çndigo (Cabecera de Tabla) */
            --stm-dark-purple: #492a63; /* Variante oscura del p√∫rpura para hover */
        }

        body { 
            background-color: #eef2f7; 
            font-size: 15px;
            font-family: 'Roboto', sans-serif; 
        }
        .main-container {
            max-width: 1100px; 
            margin: 30px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 4px solid var(--stm-indigo); 
        }
        
        /* ------------------------------------------------------------------- */
        /* ESTILOS DE ENCABEZADO RESPONSIVE (Mismos que gestor_convenios.html) */
        /* ------------------------------------------------------------------- */
        .header-main-flex {
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0; 
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-logo-title {
            display: flex;
            align-items: center;
            flex-grow: 1; 
            max-width: calc(100% - 150px); 
        }

        .header-logo-title img {
            max-width: 50px;
            height: auto; 
            border-radius: 50%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-right: 12px; 
            flex-shrink: 0;
        }

        .header-title-text {
            display: flex;
            flex-direction: column;
            line-height: 1;
        }
        
        .header-title-text .subtitle {
            font-size: 1rem;
            font-weight: 400;
            color: #4b5563;
            margin: 0;
        }
        
        .header-title-text .title {
            font-size: 1.5rem; 
            font-weight: 700;
            color: var(--stm-purple);
            margin: 0;
            white-space: nowrap;
        }
        
        .header-main-flex > .btn-dashboard {
            flex-shrink: 0;
        }
        
        @media (max-width: 767.98px) {
            .main-container {
                padding: 15px;
                margin: 15px auto;
            }
            .header-main-flex {
                flex-direction: row; 
                justify-content: space-between;
                align-items: flex-start;
            }
            .header-logo-title {
                max-width: 100%;
                flex-grow: 1;
            }
            .header-title-text .subtitle {
                font-size: 0.9rem;
            }
            .header-title-text .title {
                font-size: 1.3rem; 
            }
            .d-flex.justify-content-end.mb-4 {
                justify-content: center !important; 
                margin-bottom: 20px !important;
            }
        }
        
        /* ------------------------------------------------------------------- */
        /* ESTILOS DE BOTONES (Mismos que gestor_convenios.html) */
        /* ------------------------------------------------------------------- */
        
        .btn-stm-create {
            background-color: var(--stm-teal); 
            border-color: var(--stm-teal); 
            color: #ffffff; 
            font-weight: 600;
            padding: 10px 20px; 
            border-radius: 50px; 
            box-shadow: 0 4px 15px -3px rgba(52, 179, 197, 0.5); 
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-create:hover, 
        .btn-stm-create:focus {
            background-color: #2a8e9b; 
            border-color: #2a8e9b;
            color: #ffffff;
            transform: translateY(-2px); 
            box-shadow: 0 6px 18px -3px rgba(52, 179, 197, 0.7);
        }

        .btn-stm-save {
            background-color: var(--stm-purple); 
            border-color: var(--stm-purple); 
            color: #ffffff;
            font-weight: 600;
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(90, 55, 123, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-save:hover, 
        .btn-stm-save:focus {
            background-color: var(--stm-dark-purple); 
            border-color: var(--stm-dark-purple);
            color: #ffffff;
            transform: translateY(-1px);
        }

        .btn-dashboard {
            background-color: var(--stm-purple); 
            border-color: var(--stm-dark-purple); 
            color: #ffffff;
            font-weight: 600;
            padding: 8px 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(90, 55, 123, 0.4);
            transition: all 0.2s ease-in-out;
            text-decoration: none; 
            white-space: nowrap;
        }
        .btn-dashboard:hover,
        .btn-dashboard:focus {
            background-color: var(--stm-dark-purple); 
            border-color: var(--stm-dark-purple);
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        .btn-stm-delete {
            background-color: var(--stm-red); 
            border-color: var(--stm-red); 
            color: #ffffff; 
            border-radius: 8px; 
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-delete:hover, 
        .btn-stm-delete:focus {
            background-color: #b02a37;
            border-color: #b02a37;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        /* ------------------------------------------------------------------- */
        /* ESTILOS DE TABLA (Mismos que gestor_convenios.html) */
        /* ------------------------------------------------------------------- */
        .table-responsive {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .table thead {
            background-color: var(--stm-indigo);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table th {
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        #loadingSpinner {
            text-align: center;
            padding: 40px;
        }
        
        .table-hover tbody tr:not(.row-actions) {
            cursor: pointer;
        }
        .table-hover tbody tr:not(.row-actions):hover {
            background-color: #f0f4f9; 
        }

        /* Quitamos estilos de ACTIVO ya que no aplica a la tabla user */
        
        /* --- ESTILOS PARA LA COLUMNA ROL (NUEVO) --- */
        .rol-icon {
            font-size: 1.2rem;
            display: block;
            text-align: center;
        }
        .text-user-blue { color: #3b82f6 !important; } 
        .text-admin-red { color: var(--stm-red) !important; } 
        
        .table th.col-rol {
            width: 1%;
            text-align: center;
        }
        .table td.col-rol {
            text-align: center;
        }
        /* --------------------------------------------- */
        
    </style>
</head>
<body>

    <div class="container">
        <div class="main-container">
            
            <div class="header-main-flex">
                
                <div class="header-logo-title">
                    <img src="logo_STM.png" alt="Logo Sindicato de Trabajadores Municipales"> 
                    
                    <div class="header-title-text">
                        <p class="subtitle">Gestor de</p>
                        <h1 class="title">Usuarios</h1>
                    </div>
                </div>

                <a href="dashboard.html" class="btn btn-dashboard">
                    <i class="fas fa-chart-line me-2"></i> Tablero de mando
                </a>
            </div>
            
            <div class="d-flex justify-content-end mb-4">
                <button type="button" class="btn btn-stm-create" onclick="openModal()">
                    <i class="fas fa-plus-circle me-2"></i> Crear Nuevo Usuario
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col" class="col-rol">ROL</th> 
                            <th scope="col">Apellido</th> 
                            <th scope="col">Nombre</th> 
                            <th scope="col">Usuario</th>
                            <th scope="col">Permiso</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                    </tbody >
                </table>
                <div id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando usuarios...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando usuarios...</p>
                </div>
            </div>

        </div>
    </div>
    
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="userForm" novalidate class="needs-validation"> 
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">Crear Usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="inputIdUser" name="ID">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="inputApellido" class="form-label">
                                    Apellido: <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="inputApellido" name="Apellido" required>
                                <div class="invalid-feedback">
                                    Por favor, ingres√° el apellido.
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="inputNombre" class="form-label">
                                    Nombre: <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="inputNombre" name="Nombre" required>
                                <div class="invalid-feedback">
                                    Por favor, ingres√° el nombre.
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="inputUsuario" class="form-label">
                                Usuario (Nombre de inicio de sesi√≥n): <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="inputUsuario" name="Usuario" required>
                            <div class="invalid-feedback">
                                Por favor, ingres√° el nombre de usuario.
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="inputPassword" class="form-label">
                                    Contrase√±a: <span class="text-danger">*</span>
                                </label>
                                <input type="password" class="form-control" id="inputPassword" name="Password" required>
                                <div class="invalid-feedback">
                                    Por favor, ingres√° la contrase√±a.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="inputPermiso" class="form-label">
                                    Permiso: <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="inputPermiso" name="Permiso" required>
                                    <option value="" disabled selected>Seleccion√° un permiso</option>
                                    <option value="USER">USER</option>
                                    <option value="ADMIN">ADMIN</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, seleccion√° un permiso.
                                </div>
                            </div>
                        </div>

                        <div id="passwordWarning" class="alert alert-warning mt-3" style="display:none;">
                            Dej√° la **Contrase√±a** vac√≠a para **mantener la actual** al editar.
                        </div>
                        
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <button type="button" class="btn btn-stm-delete" id="btnEliminarEnModal" style="display: none;">
                            <i class="fas fa-trash-alt me-2"></i> Eliminar Usuario
                        </button>
                        
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelarModal">Cancelar</button>
                            <button type="submit" class="btn btn-stm-save" id="btnGuardar">Guardar Usuario</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">‚ö†Ô∏è Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro/a que quer√©s eliminar el usuario con ID: <strong id="deleteUserId" class="text-danger"></strong>?</p>
                    <p class="text-danger">¬°Esta acci√≥n no se puede deshacer!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-stm-delete" id="btnAceptarEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">Resultado de la Operaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="feedbackModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        
        // --- üö® C√ìDIGO DE VERIFICACI√ìN DE SEGURIDAD üö® ---
        if (localStorage.getItem('isAuthenticatedSTM') !== 'true') {
            window.location.href = 'index.html';
        }
        // --- FIN C√ìDIGO DE VERIFICACI√ìN ---
        
        // L√ìGICA DE JAVASCRIPT - ADAPTADA PARA USAR CAMPOS DE USUARIO
        
        // ATENCI√ìN: REEMPLAZAR CON LA URL DE DESPLIEGUE REAL PARA USUARIOS
        const APPSSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwOnYYCK-AGGt_MsK87jeT-UZxBivgFJUP-RHX4pLVqh6bxR08dbArLZ5YzNqaejCe5Hw/exec'; // ** MISMA URL DEL OTRO SCRIPT **

        const userTableBody = document.getElementById('userTableBody');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        const userForm = document.getElementById('userForm');
        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        const userModalLabel = document.getElementById('userModalLabel');
        const btnGuardar = document.getElementById('btnGuardar');
        const btnCancelarModal = document.getElementById('btnCancelarModal'); 
        
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const btnAceptarEliminar = document.getElementById('btnAceptarEliminar');
        const btnEliminarEnModal = document.getElementById('btnEliminarEnModal'); 
        
        const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        
        const inputPassword = document.getElementById('inputPassword');
        const passwordWarning = document.getElementById('passwordWarning');

        let userIdToDelete = null;

        let originalGuardarText = '';
        let originalEliminarText = '';


        document.addEventListener('DOMContentLoaded', () => {
            originalGuardarText = btnGuardar.textContent;
            originalEliminarText = btnAceptarEliminar.textContent;
            fetchUsers();
        });


        userForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            // En modo edici√≥n, si la contrase√±a est√° vac√≠a, no es necesario que est√© 'required'.
            const id = document.getElementById('inputIdUser').value;
            if (id && inputPassword.value === '') {
                inputPassword.removeAttribute('required');
            } else {
                inputPassword.setAttribute('required', 'required');
            }

            if (!userForm.checkValidity()) {
                event.stopPropagation();
                userForm.classList.add('was-validated');
                return;
            }
            
            const accion = id ? 'ACTUALIZAR' : 'CREAR';
            await manejarEnvio(accion, id);
        });

        btnEliminarEnModal.addEventListener('click', function() {
            const id = document.getElementById('inputIdUser').value;
            if (id) {
                userModal.hide(); 
                showDeleteConfirm(id);
            }
        });

        btnAceptarEliminar.addEventListener('click', async function() {
            if (userIdToDelete) {
                setLoadingState(true, 'ELIMINAR');
                confirmDeleteModal.hide();
                await manejarEnvio('ELIMINAR', userIdToDelete);
                userIdToDelete = null; 
            }
        });

        /**
         * Maneja el estado de carga de los botones principales del CRUD. (Id√©ntico al de convenios)
         */
        function setLoadingState(isLoading, accion) {
            const isGuardar = !accion || accion === 'GUARDAR';
            const isEliminar = accion === 'ELIMINAR';

            if (isGuardar) {
                btnGuardar.disabled = isLoading;
                btnCancelarModal.disabled = isLoading; 
                btnEliminarEnModal.disabled = isLoading;

                if (isLoading) {
                    btnGuardar.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Aguarde...
                    `;
                    btnGuardar.classList.add('d-flex', 'align-items-center', 'justify-content-center'); 
                } else {
                    btnGuardar.textContent = originalGuardarText;
                    btnGuardar.classList.remove('d-flex', 'align-items-center', 'justify-content-center'); 
                }
            }

            if (isEliminar) {
                btnAceptarEliminar.disabled = isLoading;

                if (isLoading) {
                    btnAceptarEliminar.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Aguarde...
                    `;
                    btnAceptarEliminar.classList.add('d-flex', 'align-items-center', 'justify-content-center');
                } else {
                    btnAceptarEliminar.textContent = originalEliminarText;
                    btnAceptarEliminar.classList.remove('d-flex', 'align-items-center', 'justify-content-center');
                }
            }
        }
        
        
        function renderTable(users) {
            userTableBody.innerHTML = '';
            loadingSpinner.style.display = 'none';
            // 5 columnas: ROL (Icono), Apellido, Nombre, Usuario, Permiso
            const COLSPAN_COUNT = 5; 

            if (users.length === 0) {
                userTableBody.innerHTML = `
                    <tr>
                        <td colspan="${COLSPAN_COUNT}" class="text-center py-4 text-muted"> 
                            A√∫n no hay usuarios cargados. ¬°Cre√° el primero!
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                
                // --- L√ìGICA DE ICONO POR PERMISO (NUEVO) ---
                const permiso = (user.permiso || '').toUpperCase().trim();
                let rolIcono, rolClase;

                if (permiso === 'ADMIN') {
                    rolIcono = 'fas fa-shield-alt'; // Escudo/Admin
                    rolClase = 'text-admin-red';
                } else {
                    rolIcono = 'fas fa-user'; // Usuario est√°ndar
                    rolClase = 'text-user-blue'; 
                }

                const iconoHtml = `<i class="rol-icon ${rolIcono} ${rolClase}" title="${permiso}"></i>`;
                // ------------------------------------
                
                const row = userTableBody.insertRow();
                
                // Se asume que los campos son ID, apellido, nombre, usuario, permiso, password (este √∫ltimo no se muestra)
                
                // --- AJUSTE DE CODIFICACI√ìN PARA EVITAR PROBLEMAS CON CARACTERES ESPECIALES ---
                // NO ENCODIFICAMOS PASSWORD, SOLO LO PASAMOS PARA RE-GUARDARLO AL EDITAR
                const encodedID = encodeURIComponent(user.ID || ''); // Seguimos necesitando el ID para la edici√≥n
                const encodedApellido = encodeURIComponent(user.apellido || '');
                const encodedNombre = encodeURIComponent(user.nombre || '');
                const encodedUsuario = encodeURIComponent(user.usuario || '');
                const encodedPassword = encodeURIComponent(user.password || ''); // Ojo: Pasamos el password guardado
                const encodedPermiso = encodeURIComponent(user.permiso || ''); 

                // Usamos los par√°metros codificados en el onclick para abrir el modal (Editar/Ver)
                row.setAttribute('onclick', `openModal(
                    '${encodedID}', 
                    '${encodedApellido}', 
                    '${encodedNombre}', 
                    '${encodedUsuario}',
                    '${encodedPassword}', 
                    '${encodedPermiso}'
                )`);
                
                // Las celdas de datos - ROL (Icono), Apellido, Nombre, Usuario, Permiso
                row.innerHTML = `
                    <td class="col-rol">${iconoHtml}</td>
                    <td>${user.apellido || 'SIN APELLIDO'}</td> 
                    <td>${user.nombre || 'SIN NOMBRE'}</td>
                    <td>${user.usuario || 'SIN USER'}</td>
                    <td>${user.permiso || 'SIN PERMISO'}</td>
                    `;
                
            });
            
        }

        // --- AJUSTE DE DECODIFICACI√ìN AL RECIBIR LOS DATOS ---
        function openModal(encodedID = '', encodedApellido = '', encodedNombre = '', encodedUsuario = '', encodedPassword = '', encodedPermiso = '') {
            
            // Decodificar los par√°metros recibidos
            const id = decodeURIComponent(encodedID);
            const apellido = decodeURIComponent(encodedApellido);
            const nombre = decodeURIComponent(encodedNombre);
            const usuario = decodeURIComponent(encodedUsuario);
            const password = decodeURIComponent(encodedPassword); 
            const permiso = decodeURIComponent(encodedPermiso);

            // ------------------------------------------------------------------
            
            userForm.reset(); 
            userForm.classList.remove('was-validated'); 
            
            const inputIdUser = document.getElementById('inputIdUser');
            const inputApellido = document.getElementById('inputApellido');
            const inputNombre = document.getElementById('inputNombre'); 
            const inputUsuario = document.getElementById('inputUsuario'); 
            const inputPassword = document.getElementById('inputPassword'); 
            const inputPermiso = document.getElementById('inputPermiso'); 
            
            // Resetear el campo de password a no-required para el modo Edici√≥n, si lo estaba
            inputPassword.setAttribute('required', 'required'); 
            inputPassword.value = ''; // Siempre limpio el campo de contrase√±a
            passwordWarning.style.display = 'none'; // Oculto la advertencia por defecto

            // Si el ID decodificado es vac√≠o o 'undefined', lo dejamos vac√≠o.
            inputIdUser.value = id === 'undefined' ? '' : id; 

            if (id && id !== 'undefined' && id !== '') {
                // Modo Edici√≥n
                userModalLabel.textContent = 'Editar Usuario';
                originalGuardarText = 'Guardar Cambios';
                
                inputApellido.value = apellido;
                inputNombre.value = nombre;
                inputUsuario.value = usuario; 
                inputPermiso.value = permiso; 

                // IMPORTANTE: Adjuntamos el password guardado en un campo temporal para reenviarlo si el input queda vac√≠o.
                inputIdUser.dataset.originalPassword = password; 
                
                // Ya no es requerido el campo de contrase√±a para actualizar
                inputPassword.removeAttribute('required'); 
                passwordWarning.style.display = 'block'; 

                btnEliminarEnModal.style.display = 'block'; 
                
            } else {
                // Modo Creaci√≥n
                userModalLabel.textContent = 'Crear Nuevo Usuario';
                originalGuardarText = 'Guardar Usuario';
                inputPermiso.value = ""; 
                inputPassword.setAttribute('required', 'required'); 

                btnEliminarEnModal.style.display = 'none'; 
                inputIdUser.dataset.originalPassword = ''; 
            }
            
            setLoadingState(false, 'GUARDAR');

            userModal.show();
        }
        // --- FIN DE AJUSTE CLAVE: Decodificamos los datos al recibirlos ---

        function showDeleteConfirm(id) {
            userIdToDelete = id;
            document.getElementById('deleteUserId').textContent = id;
            setLoadingState(false, 'ELIMINAR');
            confirmDeleteModal.show();
        }

        function showFeedback(message, success = true) {
            const title = success ? '‚úÖ ¬°Operaci√≥n Exitosa!' : '‚ùå ¬°Error!';
            const header = document.getElementById('feedbackModal').querySelector('.modal-header');
            const titleEl = document.getElementById('feedbackModalLabel');
            
            titleEl.textContent = title;
            header.classList.remove('bg-danger', 'bg-success', 'text-white');
            
            document.getElementById('feedbackModalBody').innerHTML = `<p>${message}</p>`;

            if (success) {
                header.classList.add('bg-success', 'text-white'); 
            } else {
                header.classList.add('bg-danger', 'text-white'); 
            }
            document.getElementById('feedbackModal').querySelector('.btn-close').classList.add('btn-close-white');

            feedbackModal.show();
        }


        async function fetchUsers() {
            loadingSpinner.style.display = 'block';
            userTableBody.innerHTML = ''; 

            try {
                // Usamos action=READ_ALL del doGet
                const response = await fetch(APPSSCRIPT_URL + '?action=READ_ALL');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const dataArray = data.users; // Cambiamos 'convenios' por 'users'
                    
                    if (data.status === 'success' && Array.isArray(dataArray)) {
                        
                        // Ordenamos por Apellido (Ascendente)
                        dataArray.sort((a, b) => {
                            const apellidoA = String(a.apellido || '').toUpperCase();
                            const apellidoB = String(b.apellido || '').toUpperCase();
                            if (apellidoA < apellidoB) return -1;
                            if (apellidoA > apellidoB) return 1;
                            return 0;
                        });
                        
                        renderTable(dataArray);
                    } else {
                        throw new Error(data.message || 'Error en el formato de datos devueltos. Asegurate que tu AppScript devuelva status: success y un array de users.');
                    }
                } else {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                loadingSpinner.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        Error al cargar los usuarios: ${error.message}
                        <br>Revis√° la configuraci√≥n de tu AppScript y la URL.
                    </div>
                `;
                console.error('Error al cargar usuarios:', error);
            }
        }

        async function manejarEnvio(accion, id) {
            let method, body, apiUrl, successMessage;

            setLoadingState(true, accion === 'ELIMINAR' ? 'ELIMINAR' : 'GUARDAR');
            
            // Usamos FormData 
            const formData = new FormData(userForm); 

            // Manejo de la contrase√±a en modo ACTUALIZAR
            if (accion === 'ACTUALIZAR') {
                const newPassword = formData.get('Password');
                const originalPassword = document.getElementById('inputIdUser').dataset.originalPassword;
                
                if (!newPassword || newPassword === '') {
                    // Si el campo de password est√° vac√≠o, usamos el password original guardado.
                    formData.set('Password', originalPassword);
                }
            }
            
            // Aseguramos que el campo ID no se env√≠e en CREAR
            if (accion === 'CREAR') {
                formData.delete('ID');
            }
            
            switch (accion) {
                case 'CREAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    formData.append('action', 'CREATE');
                    body = formData;
                    successMessage = 'El usuario se cre√≥ exitosamente.';
                    break;
                case 'ACTUALIZAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    formData.append('action', 'UPDATE');
                    formData.append('ID', id);
                    body = formData;
                    successMessage = `El usuario se actualiz√≥ correctamente.`;
                    break;
                case 'ELIMINAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    const deleteData = new FormData();
                    deleteData.append('action', 'DELETE');
                    deleteData.append('ID', id);
                    body = deleteData;
                    successMessage = `El usuario fue eliminado.`;
                    break;
                default:
                    showFeedback('Acci√≥n desconocida.', false);
                    return;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: method,
                    body: body 
                });

                const responseText = await response.text();
                let result = {};
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    if (responseText.includes('Error')) {
                        throw new Error('Error desconocido del servidor de AppScript.');
                    }
                    result = { status: 'success' };
                }

                if (response.ok && result.status === 'success') {
                    userModal.hide();
                    showFeedback(successMessage, true);
                    await fetchUsers(); // Recarga la tabla
                } else {
                    const errorDetail = result.message || 'Error en la operaci√≥n en la planilla.';
                    throw new Error(errorDetail);
                }

            } catch (error) {
                if (accion !== 'ELIMINAR') {
                    userModal.hide();
                }
                showFeedback(`¬°Error al ejecutar la operaci√≥n! Detalle: ${error.message}`, false);
                console.error(`Error de ${accion}:`, error);
            } finally {
                setLoadingState(false, accion === 'ELIMINAR' ? 'ELIMINAR' : 'GUARDAR');
            }
        }

    </script>
</body>
</html>