<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beneficios y Convenios STM</title>
    <!-- Cargamos la nueva tipografía: Poppins (más moderna y con personalidad) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Incluimos Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Usamos Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Configuraciones personalizadas de Tailwind (Paleta STM) */
        :root {
            --color-stm-purple: #5A377B; /* Púrpura principal (Fuerte) */
            --color-stm-teal: #34B3C5;   /* Turquesa (Acento Vibrante) */
            --color-bg-light: #f7f7f8;   /* Fondo muy claro */
            --color-card-bg: #ffffff;    /* Fondo de tarjeta blanco puro */
        }

        /* Aplicar la fuente POPPINS y colores base */
        body {
            font-family: 'Poppins', sans-serif; /* ¡Tipografía cambiada a Poppins! */
            background-color: var(--color-bg-light);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* Contenedor principal para simular la pantalla de una app */
        .app-container {
            max-width: 480px; 
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--color-card-bg); 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1); 
        }
        
        /* Estilo para el contenedor principal de tarjetas (Acordeón) */
        .convenio-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.08); 
            border-radius: 1rem; 
            overflow: hidden;
            background-color: var(--color-card-bg);
        }
        
        /* Efecto al pasar el mouse (lift) y focus - Más pronunciado */
        .convenio-card:hover, .convenio-card.open {
            transform: translateY(-3px); 
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15);
            border-color: var(--color-stm-teal); 
        }
        
        /* Estilo para la barra de título del convenio */
        .convenio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem; 
            background-color: var(--color-card-bg);
            user-select: none;
            transition: background-color 0.2s;
        }

        /* Estilo al estar abierta la tarjeta */
        .convenio-card.open .convenio-header {
            background-color: #fcfcfc; 
        }
        
        /* Estilo del Rubro Tag (púrpura STM) */
        .rubro-tag {
            transition: all 0.2s ease;
            background-color: var(--color-stm-purple); 
            box-shadow: 0 2px 8px rgba(90, 55, 123, 0.4); 
        }

        /* Estilo del contenido desplegable */
        .convenio-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.25rem;
            background-color: #ffffff;
        }
        
        /* Estilo del contenido al estar abierto */
        .convenio-card.open .convenio-content {
            max-height: 1000px; 
            padding: 1rem 1.25rem 1.5rem; 
        }

        /* Icono de flecha giratoria (con color de acento turquesa) */
        .chevron {
            transition: transform 0.4s ease-out; 
            color: var(--color-stm-teal); 
            font-size: 1rem;
        }
        .convenio-card.open .chevron {
            transform: rotate(180deg);
        }

        /* Estilo para el contenedor de filtros ya no es sticky */
        .filter-container {
            padding: 0 1rem 1rem 1rem;
        }
        
        /* Estilo para la tarjeta de rubro */
        .rubro-tile {
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: var(--color-card-bg);
            padding: 1rem;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 2px solid transparent;
        }
        
        .rubro-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        .rubro-tile.active {
            border-color: var(--color-stm-teal);
            box-shadow: 0 0 15px rgba(52, 179, 197, 0.5); /* Sombra turquesa */
        }
        
        .rubro-icon-bg {
            /* Fondo del icono Turquesa, borde Púrpura */
            background-color: rgba(52, 179, 197, 0.1); /* Turquesa muy suave */
            border: 2px solid var(--color-stm-purple);
            color: var(--color-stm-teal);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Clase para la imagen del logo STM */
        .stm-logo-header {
            width: 36px;
            height: 36px;
            object-fit: contain;
            /* Aplicamos el mismo efecto visual de 'animate-pulse' al logo */
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>

    <!-- Contenedor Principal que simula la pantalla de un móvil -->
    <div class="app-container">
        
        <!-- HEADER / Barra de Navegación Estilo App (Full width, STM Purple) -->
        <header class="p-5 bg-[var(--color-stm-purple)] text-white shadow-xl">
            <div class="flex items-center">
                <!-- LOGO STM (Imagen subida por el usuario) -->
                <img src="http://googleusercontent.com/image_generation_content/0" 
                     onerror="this.onerror=null; this.src='https://placehold.co/36x36/5A377B/FFFFFF?text=STM';"
                     alt="Logo STM" 
                     class="stm-logo-header mr-3">
                     
                <!-- Usamos 'font-extrabold' y 'tracking-tight' de Poppins -->
                <h1 class="text-2xl font-extrabold tracking-tight">
                    BENEFICIOS STM
                </h1>
            </div>
            <p class="text-indigo-200 text-sm mt-1 font-light">
                Convenios exclusivos y llamativos para vos.
            </p>
        </header>

        <!-- Contenedor de Rubros (Reemplaza el select filter) -->
        <div class="filter-container">
            <!-- Título actualizado: Explorar Rubros -->
            <h2 class="text-lg font-bold text-gray-800 pt-5 mb-3 px-1">
                <i class="fas fa-cubes text-[var(--color-stm-teal)] mr-2"></i> Explorar Rubros
            </h2>

            <!-- Grid para mostrar los rubros como tarjetas -->
            <div id="rubroGrid" class="grid grid-cols-3 gap-3 mb-6">
                <!-- Aquí se cargarán dinámicamente las tarjetas de rubros -->
                <!-- Placeholder mientras carga -->
                <div class="col-span-3 text-center p-4 text-gray-500" id="rubroGridLoading">Cargando rubros...</div>
            </div>
            
            <!-- Input de filtro anterior (oculto, solo para compatibilidad) -->
            <select id="rubroFilter" class="hidden"></select>
        </div>

        <!-- Contenedor principal de los convenios (con padding interior) -->
        <div class="p-4 space-y-4">
            
            <h2 class="text-xl font-bold text-gray-800 mb-4 px-1" id="conveniosTitle">
                Convenios Destacados:
            </h2>

            <div id="conveniosList" class="space-y-4 pb-12">
                <!-- Spinner de carga inicial -->
                <div id="loadingSpinner" class="text-center p-12 bg-gray-100 rounded-2xl shadow-inner">
                    <i class="fas fa-spinner fa-spin text-5xl text-[var(--color-stm-teal)]"></i>
                    <p class="mt-4 text-gray-700 font-bold text-lg">Cargando beneficios...</p>
                </div>
                
                <!-- Aquí se cargarán dinámicamente los convenios -->
            </div>

            <!-- Mensaje de no resultados (oculto por defecto) -->
            <div id="noResults" class="hidden text-center p-10 bg-red-50 rounded-2xl shadow-md border-2 border-red-300 mt-6">
                <i class="fas fa-search-minus text-4xl text-red-500"></i>
                <p class="mt-4 text-red-700 font-bold">¡Uy! No hay convenios en este rubro.</p>
                <p class="text-sm text-red-600">Probá seleccionando "TODOS" en los rubros de arriba.</p>
            </div>
            
        </div>
        
        <!-- FOOTER (Simple para mobile) -->
        <footer class="p-4 text-center text-xs text-gray-500 border-t mt-6 bg-gray-50">
            <p>&copy; 2024 STM - Sindicato de Trabajadores Municipales</p>
        </footer>
    </div>

    <script>
        // La URL de tu AppScript que devuelve los datos de los convenios
        // NOTA: Reemplazar con la URL real de tu AppScript
        const APPSSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgD9-ggtZjFyK7I4FfwLETVtj5TUBvQIZWF5om5yAKLhj4BuerpbdHN-3PnTfLDzdxBA/exec'; 

        const conveniosList = document.getElementById('conveniosList');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const rubroGrid = document.getElementById('rubroGrid');
        const rubroGridLoading = document.getElementById('rubroGridLoading');
        const noResults = document.getElementById('noResults');
        const conveniosTitle = document.getElementById('conveniosTitle');
        let allConvenios = []; // Almacenará todos los convenios cargados
        let uniqueRubros = new Set(); // Almacenará los rubros únicos
        let currentFilter = 'TODOS'; // Filtro actual seleccionado

        document.addEventListener('DOMContentLoaded', () => {
            fetchConvenios();
            // Ya no escuchamos el evento 'change' del select, sino los clics en la grilla.
        });
        
        /**
         * Simula un simple fetch con reintento y backoff exponencial (para manejar posibles fallos de red)
         */
        async function fetchWithRetry(url, options = {}, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    // Espera con backoff exponencial
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }
        
        /**
         * Carga los convenios desde el AppScript.
         */
        async function fetchConvenios() {
            loadingSpinner.classList.remove('hidden');
            conveniosList.innerHTML = '';
            noResults.classList.add('hidden');
            rubroGridLoading.classList.remove('hidden');

            try {
                const response = await fetchWithRetry(APPSSCRIPT_URL + '?action=READ_ALL');
                const responseText = await response.text();
                
                let data = {};
                try {
                    data = JSON.parse(responseText);
                } catch(e) {
                     throw new Error('Respuesta del servidor no es JSON válida o estructura inesperada.');
                }
                
                const dataArray = data.convenios || data.novedades; 
                
                if (data.status === 'success' && Array.isArray(dataArray)) {
                    allConvenios = dataArray.filter(c => (c.ACTIVO || '').toUpperCase().trim() === 'SI');
                    
                    // 1. Obtener y renderizar los rubros en la grilla
                    populateRubroGrid(allConvenios);
                    
                    // 2. Renderizar todos los convenios por defecto (currentFilter es 'TODOS')
                    filterConvenios(currentFilter); 

                } else {
                    throw new Error(data.message || 'Error: Formato de datos inesperado o status no es "success".');
                }
            } catch (error) {
                console.error('Error al cargar convenios:', error);
                conveniosList.innerHTML = `
                    <div class="alert bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md" role="alert">
                        <h4 class="font-bold">¡Error de Conexión!</h4>
                        <p>No se pudieron cargar los convenios. Verificá la URL del AppScript o la conexión a internet.</p>
                        <p class="text-sm mt-1">Detalle: ${error.message}</p>
                    </div>
                `;
                rubroGridLoading.classList.add('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Rellena el grid de rubros únicos y añade la opción TODOS.
         */
        function populateRubroGrid(convenios) {
            rubroGrid.innerHTML = '';
            uniqueRubros = new Set();

            convenios.forEach(c => {
                if (c.rubro) {
                    uniqueRubros.add(c.rubro.toUpperCase().trim());
                }
            });
            
            let rubrosArray = Array.from(uniqueRubros).sort();

            // Agregar la opción "TODOS" al principio
            rubrosArray.unshift('TODOS');

            renderRubroGrid(rubrosArray);
        }
        
        /**
         * Renderiza la grilla de tarjetas de rubros.
         */
        function renderRubroGrid(rubros) {
            rubroGridLoading.classList.add('hidden');
            rubroGrid.innerHTML = '';
            
            rubros.forEach(rubro => {
                const isTodos = rubro === 'TODOS';
                const rubroName = isTodos ? 'TODOS los Rubros' : rubro;
                const rubroIcon = isTodos ? '<i class="fas fa-search"></i>' : getRubroIcon(rubro, true);
                
                const card = document.createElement('div');
                card.className = 'col-span-1';
                card.innerHTML = `
                    <div class="rubro-tile ${rubro === currentFilter ? 'active' : ''}" data-rubro="${rubro}">
                        <div class="rubro-icon-bg mx-auto">
                            ${rubroIcon}
                        </div>
                        <p class="text-xs font-bold text-gray-800 uppercase leading-tight">${rubroName}</p>
                        <!-- Opcional: descripción corta si existiera -->
                    </div>
                `;
                
                // Asigna la función de filtro al hacer click
                card.querySelector('.rubro-tile').onclick = function() {
                    currentFilter = rubro;
                    filterConvenios(rubro);
                    // Actualiza la clase activa
                    document.querySelectorAll('.rubro-tile').forEach(tile => tile.classList.remove('active'));
                    this.classList.add('active');
                };
                
                rubroGrid.appendChild(card);
            });
        }
        
        /**
         * Filtra los convenios basados en la selección del rubro y actualiza la vista.
         */
        function filterConvenios(selectedRubro) {
            currentFilter = selectedRubro;
            let filteredConvenios = [];

            if (selectedRubro === 'TODOS') {
                filteredConvenios = allConvenios;
                conveniosTitle.textContent = "Convenios Destacados:";
            } else {
                filteredConvenios = allConvenios.filter(c => 
                    (c.rubro || '').toUpperCase().trim() === selectedRubro
                );
                conveniosTitle.textContent = `Convenios en: ${selectedRubro}`;
            }

            renderConvenios(filteredConvenios);
            
            // Si hay que hacer scroll al cambiar de rubro (opcional)
            if (filteredConvenios.length > 0) {
                 // Hacemos scroll suave a la lista de convenios
                 conveniosTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        /**
         * Devuelve un icono de Font Awesome basado en el nombre del rubro.
         * isTile=true cambia el icono a uno más general para la grilla
         */
        function getRubroIcon(rubro, isTile = false) {
            const r = rubro.toUpperCase().trim();
            // Iconos ajustados para ser más descriptivos
            switch (r) {
                case 'SALUD':
                case 'MEDICINA':
                    return isTile ? '<i class="fas fa-kit-medical"></i>' : '<i class="fas fa-heart-pulse mr-1"></i>'; 
                case 'EDUCACION':
                case 'FORMACION':
                    return isTile ? '<i class="fas fa-graduation-cap"></i>' : '<i class="fas fa-book-open-reader mr-1"></i>'; 
                case 'TURISMO':
                case 'VIAJES':
                    return isTile ? '<i class="fas fa-map-marked-alt"></i>' : '<i class="fas fa-plane-departure mr-1"></i>'; 
                case 'DEPORTES':
                case 'GIMNASIOS':
                    return isTile ? '<i class="fas fa-running"></i>' : '<i class="fas fa-dumbbell mr-1"></i>'; 
                case 'COMERCIO':
                case 'COMPRAS':
                    return isTile ? '<i class="fas fa-tags"></i>' : '<i class="fas fa-store mr-1"></i>'; 
                case 'GASTRONOMIA':
                case 'COMIDA':
                    return isTile ? '<i class="fas fa-burger"></i>' : '<i class="fas fa-utensils mr-1"></i>'; 
                case 'SERVICIOS':
                    return isTile ? '<i class="fas fa-tools"></i>' : '<i class="fas fa-screwdriver-wrench mr-1"></i>'; 
                case 'BELLEZA':
                case 'ESTETICA':
                    return isTile ? '<i class="fas fa-gem"></i>' : '<i class="fas fa-spa mr-1"></i>'; 
                case 'FINANZAS':
                    return isTile ? '<i class="fas fa-piggy-bank"></i>' : '<i class="fas fa-sack-dollar mr-1"></i>'; 
                case 'LEGAL':
                    return isTile ? '<i class="fas fa-gavel"></i>' : '<i class="fas fa-balance-scale-right mr-1"></i>'; 
                default:
                    return isTile ? '<i class="fas fa-star"></i>' : '<i class="fas fa-star mr-1"></i>'; 
            }
        }

        /**
         * Renderiza la lista de convenios en formato de acordeón.
         */
        function renderConvenios(convenios) {
            conveniosList.innerHTML = '';
            
            // Cierra todas las tarjetas abiertas antes de renderizar (limpieza visual)
            document.querySelectorAll('.convenio-card.open').forEach(openCard => {
                openCard.classList.remove('open');
            });
            
            if (convenios.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            convenios.forEach(convenio => {
                const rubro = (convenio.rubro || 'SIN RUBRO').toUpperCase().trim();
                const titulo = convenio.titulo || 'Convenio sin Título';
                const detalle = (convenio.detalle || 'Detalle no especificado.').replace(/\n/g, '<br>'); 
                const rubroIcon = getRubroIcon(rubro, false); // Usamos el icono de lista (no tile)

                const card = document.createElement('div');
                card.className = 'convenio-card'; 

                // Asigna la función de toggling al hacer click en la tarjeta
                card.onclick = function() {
                    toggleConvenio(this);
                };

                card.innerHTML = `
                    <div class="convenio-header hover:bg-gray-50 active:bg-gray-100 transition duration-150">
                        <!-- Lado Izquierdo: Rubro y Título -->
                        <div class="flex-1 min-w-0 pr-4">
                            <!-- Tag Púrpura Fuerte -->
                            <span class="rubro-tag inline-block px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-full text-white mb-2 shadow-lg">
                                ${rubroIcon} ${rubro} 
                            </span>
                            <!-- Título con más peso tipográfico -->
                            <h2 class="text-xl font-extrabold text-gray-900">${titulo}</h2>
                        </div>
                        
                        <!-- Lado Derecho: Icono de Despliegue Turquesa -->
                        <div class="flex-shrink-0">
                            <i class="fas fa-chevron-down chevron text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Contenido Desplegable (Detalle) -->
                    <div class="convenio-content">
                        <div class="text-base text-gray-700 leading-relaxed">
                            <!-- Detalle del beneficio con color de acento Púrpura -->
                            <h3 class="font-bold text-[var(--color-stm-purple)] mb-3 border-b-2 border-gray-100 pb-1">Detalles y Beneficios:</h3>
                            <p>${detalle}</p>
                        </div>
                        
                        <!-- BLOQUE DEL BOTÓN ELIMINADO SEGÚN SOLICITUD DEL USUARIO -->
                    </div>
                `;
                conveniosList.appendChild(card);
            });
        }
        
        /**
         * Abre o cierra la tarjeta de convenio y cierra las otras abiertas.
         */
        function toggleConvenio(card) {
            const isOpen = card.classList.contains('open');

            // 1. Cerrar todas las otras tarjetas abiertas
            document.querySelectorAll('.convenio-card.open').forEach(openCard => {
                if (openCard !== card) {
                    openCard.classList.remove('open');
                }
            });

            // 2. Abrir/Cerrar la tarjeta actual
            if (!isOpen) {
                card.classList.add('open');
            } else {
                card.classList.remove('open');
            }
        }
    </script>
</body>
</html>