<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TÍTULO ACTUALIZADO -->
    <title>Convenios STM</title>
    <!-- Cargamos la tipografía ROBOTO (como en novedades.html) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- Incluimos Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Usamos Font Awesome 6 para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Configuraciones personalizadas de Tailwind (Paleta STM) */
        :root {
            --color-stm-purple: #5A377B; /* Púrpura principal */
            --color-stm-teal: #34B3C5;   /* Turquesa (Acento Vibrante - Resalte) */
            --color-bg-light: #f7f7f8;   /* Fondo muy claro */
            --color-card-bg: #ffffff;    /* Fondo de tarjeta blanco puro */
            
            /* Colores Rubro (Ajustados a tonos más planos tipo Bootstrap) */
            --color-rubro-primary: #0d6efd;
            --color-rubro-success: #198754;
            --color-rubro-warning: #ffc107;
            --color-rubro-danger: #dc3545;
            --color-rubro-info: #0dcaf0;
            --color-rubro-secondary: #6c757d;
        }

        /* ************************************************* */
        /* FIX DE SCROLL CRÍTICO & FUENTE ROBOTO */
        /* ************************************************* */
        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', sans-serif; /* APLICAMOS ROBOTO */
            background-color: var(--color-bg-light);
        }
        
        .app-container {
            max-width: 480px; 
            margin: 0 auto;
            height: 100%; 
            background-color: var(--color-card-bg); 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1); 
            display: flex;
            flex-direction: column;
        }
        
        .content-area {
            flex: 1; 
            position: relative;
            overflow-y: auto; /* PERMITE SCROLL VERTICAL EN LA ZONA CENTRAL */
            background-color: var(--color-card-bg);
        }

        /* ==================================== */
        /* CSS para el Efecto FLIP 3D */
        /* ==================================== */
        .flip-container {
            width: 100%;
            height: 100%; 
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
        }
        
        .flip-container.flipped {
            transform: rotateY(180deg);
        }

        .flip-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* PERMITE EL SCROLL DENTRO DE CADA CARA */
            padding-bottom: 1rem; 
        }

        .back-face {
            transform: rotateY(180deg);
            padding: 1rem; 
        }

        /* ==================================== */
        /* Estilos de Rubro Tile (Estilo Sólido/Bootstrap) */
        /* ==================================== */
        
        .rubro-tile {
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: 0.5rem; /* Menos redondeado, más estilo Bootstrap */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Sombra más sutil */
            background-color: var(--color-bg-light); /* Fondo claro para resaltar icono */
            padding: 1rem 0.5rem;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid #e5e7eb;
        }
        
        .rubro-tile:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        
        .rubro-tile.active {
            border-color: var(--color-stm-teal);
            box-shadow: 0 0 0 3px rgba(52, 179, 197, 0.3);
            transform: scale(1.0); /* Mantenemos escala para simpleza */
        }
        
        /* Contenedor del icono/imagen */
        .rubro-icon-bg {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 3.5rem; /* Icono más chico */
            height: 3.5rem; 
            border-radius: 50%;
            font-size: 1.5rem; 
            margin-bottom: 0.5rem;
            margin-left: auto;
            margin-right: auto;
            background-color: #f0f0f0; /* Fondo gris claro */
            color: #333;
        }

        .stm-logo-header {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }
        
        /* Estilos de las tarjetas (Acordeón) */
        .convenio-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05); /* Sombra más sutil */
            border-radius: 0.75rem; /* Ajuste a estilo más sobrio */
            overflow: hidden;
            background-color: var(--color-card-bg);
        }
        
        .convenio-card:hover, .convenio-card.open {
            border-color: var(--color-stm-teal); 
            box-shadow: 0 4px 8px rgba(52, 179, 197, 0.2); 
            transform: none; /* Desactivamos el transform de hover */
        }
        
        .rubro-tag {
            transition: all 0.2s ease;
            background-color: var(--color-stm-purple); 
            box-shadow: none; /* Quitamos sombra exagerada */
            font-weight: 500; /* Peso de fuente medio */
        }

        .convenio-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.25rem;
            background-color: #fcfcfc; /* Fondo ligeramente diferente para el contenido */
        }
        
        .convenio-card.open .convenio-content {
            max-height: 1000px; 
            padding: 1rem 1.25rem 1.5rem; 
        }

        .chevron {
            transition: transform 0.4s ease-out; 
            color: var(--color-stm-purple); /* Cambiamos a púrpura para mejor contraste */
            font-size: 1rem;
        }
        .convenio-card.open .chevron {
            transform: rotate(180deg);
        }

        .filter-container {
            padding: 0 1rem 1rem 1rem;
        }

        /* Estilos específicos para el título principal, más grandes y prominentes */
        .header-title {
            font-weight: 700; /* Bold */
            letter-spacing: -0.02em; /* Traking ajustado */
        }
    </style>
</head>
<body>

    <!-- Contenedor Principal que simula la pantalla de un móvil -->
    <div class="app-container">
        
        <!-- HEADER / Barra de Navegación (ESTÁTICO) -->
        <header class="p-5 bg-[var(--color-stm-purple)] text-white shadow-xl flex-shrink-0">
            <div class="flex items-center">
                <!-- LOGO STM (Imagen subida por el usuario) -->
                <img src="http://googleusercontent.com/image_generation_content/0" 
                     onerror="this.onerror=null; this.src='https://placehold.co/36x36/5A377B/FFFFFF?text=STM';"
                     alt="Logo STM" 
                     class="stm-logo-header mr-3">
                     
                <!-- TÍTULO -->
                <h1 class="header-title text-2xl tracking-tight">
                    CONVENIOS STM
                </h1>
            </div>
            <!-- SUBTÍTULO -->
            <p class="text-indigo-200 text-sm mt-1 font-light">
                Convenios exclusivos para vos.
            </p>
        </header>

        <!-- AREA DE CONTENIDO (ESTE CONTENEDOR ES EL QUE GIRA Y SCROLLEA) -->
        <div class="content-area">
            <div id="flipContainer" class="flip-container">
                
                <!-- CARA FRONTAL: GRID DE RUBROS -->
                <div id="frontFace" class="flip-face front-face pt-4">
                    <div class="filter-container">
                        <!-- Título actualizado: Explorar Rubros -->
                        <h2 class="text-lg font-bold text-gray-800 pt-1 mb-3 px-1">
                            <i class="fas fa-cubes text-[var(--color-stm-teal)] mr-2"></i> Explorar Rubros
                        </h2>
    
                        <!-- Grid para mostrar los rubros como tarjetas -->
                        <div id="rubroGrid" class="grid grid-cols-3 gap-3 mb-6">
                            <div class="col-span-3 text-center p-4 text-gray-500" id="rubroGridLoading">Cargando rubros...</div>
                        </div>
                    </div>
                </div>
                
                <!-- CARA TRASERA: LISTA DE CONVENIOS -->
                <div id="backFace" class="flip-face back-face">
                    
                    <!-- Botón para volver a la lista de Rubros (Back Button) -->
                    <button id="backToRubros" 
                            class="mb-4 flex items-center text-sm font-medium text-white bg-[var(--color-stm-teal)] hover:bg-[#2092a4] active:bg-[#1a7080] transition duration-150 py-2 px-4 rounded-full shadow-md self-start">
                        <i class="fas fa-arrow-left mr-2"></i> Volver a Rubros
                    </button>
                    
                    <h2 class="text-xl font-bold text-gray-800 mb-4 px-1" id="conveniosTitle">
                        Convenios Destacados:
                    </h2>
        
                    <div id="conveniosList" class="space-y-4 pb-12 flex-grow">
                        <!-- Spinner de carga inicial -->
                        <div id="loadingSpinner" class="text-center p-12 bg-gray-100 rounded-lg shadow-inner">
                            <i class="fas fa-spinner fa-spin text-5xl text-[var(--color-stm-teal)]"></i>
                            <p class="mt-4 text-gray-700 font-medium text-lg">Cargando beneficios...</p>
                        </div>
                        
                        <!-- Aquí se cargarán dinámicamente los convenios -->
                    </div>
        
                    <!-- Mensaje de no resultados (oculto por defecto) -->
                    <div id="noResults" class="hidden text-center p-10 bg-gray-100 rounded-lg shadow-md border border-gray-300 mt-6 flex-shrink-0">
                        <i class="fas fa-search-minus text-4xl text-gray-500"></i>
                        <p class="mt-4 text-gray-700 font-bold">¡Uy! No hay convenios en este rubro.</p>
                        <p class="text-sm text-gray-600">Probá seleccionando "TODOS" en los rubros de arriba.</p>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <!-- Botón de Consultas (Fijo y Visible) -->
        <div id="consultasButtonContainer" class="p-3 bg-white border-t shadow-2xl flex-shrink-0">
            <a href="consultas.html" 
               class="w-full inline-flex items-center justify-center py-3 rounded-lg font-bold text-lg transition duration-200 hover:scale-[1.01]"
               style="background-color: var(--color-stm-purple); color: white; box-shadow: 0 4px 10px rgba(90, 55, 123, 0.4);">
                <i class="fas fa-comment-dots mr-2"></i> Formulario de Consultas
            </a>
        </div>

        <!-- FOOTER (ESTÁTICO) - TEXTO Y AÑO ACTUALIZADOS -->
        <footer class="p-4 text-center text-xs text-gray-500 border-t mt-auto bg-gray-50 flex-shrink-0">
            <p>&copy; 2025 STM Sindicato de Trabajadores Municipales</p>
        </footer>
    </div>

    <script>
        // La URL de tu AppScript que devuelve los datos de los convenios
        const APPSSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgD9-ggtZjFyK7I4FfwLETVtj5TUBvQIZWF5om5yAKLhj4BuerpbdHN-3PnTfLDzdxBA/exec'; 

        const flipContainer = document.getElementById('flipContainer');
        const conveniosList = document.getElementById('conveniosList');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const rubroGrid = document.getElementById('rubroGrid');
        const rubroGridLoading = document.getElementById('rubroGridLoading');
        const noResults = document.getElementById('noResults');
        const conveniosTitle = document.getElementById('conveniosTitle');
        const backButton = document.getElementById('backToRubros');
        
        let allConvenios = []; 
        let uniqueRubros = new Set();
        let currentFilter = 'TODOS'; 

        document.addEventListener('DOMContentLoaded', () => {
            fetchConvenios();
            
            backButton.addEventListener('click', () => {
                flipTo('front');
            });
        });
        
        /**
         * Simula un simple fetch con reintento y backoff exponencial (para manejar posibles fallos de red)
         */
        async function fetchWithRetry(url, options = {}, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }
        
        /**
         * Controla el giro de la pantalla (front: rubros, back: convenios).
         */
        function flipTo(face) {
            if (face === 'back') {
                flipContainer.classList.add('flipped');
            } else {
                flipContainer.classList.remove('flipped');
            }
            // Asegurarse de que el scroll se resetee al cambiar de cara
            const activeFace = face === 'front' ? document.getElementById('frontFace') : document.getElementById('backFace');
            activeFace.scrollTop = 0;
        }

        /**
         * Carga los convenios desde el AppScript.
         */
        async function fetchConvenios() {
            loadingSpinner.classList.remove('hidden');
            conveniosList.innerHTML = '';
            noResults.classList.add('hidden');
            rubroGridLoading.classList.remove('hidden');

            try {
                const response = await fetchWithRetry(APPSSCRIPT_URL + '?action=READ_ALL');
                const responseText = await response.text();
                
                let data = {};
                try {
                    data = JSON.parse(responseText);
                } catch(e) {
                     throw new Error('Respuesta del servidor no es JSON válida o estructura inesperada.');
                }
                
                const dataArray = data.convenios || data.novedades; 
                
                if (data.status === 'success' && Array.isArray(dataArray)) {
                    // Filtra solo los activos, independientemente de mayúsculas/minúsculas
                    allConvenios = dataArray.filter(c => (c.ACTIVO || '').toUpperCase().trim() === 'SI');
                    
                    // 1. Obtener y renderizar los rubros en la grilla (Front Face)
                    populateRubroGrid(allConvenios);
                    
                    // 2. Renderizar todos los convenios por defecto (Back Face)
                    filterConvenios(currentFilter, false); 

                } else {
                    throw new Error(data.message || 'Error: Formato de datos inesperado o status no es "success".');
                }
            } catch (error) {
                console.error('Error al cargar convenios:', error);
                
                // Mostrar el error en la cara frontal si no se pudo cargar
                document.getElementById('frontFace').innerHTML = `
                    <div class="alert bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md m-4" role="alert">
                        <h4 class="font-bold">¡Error de Conexión!</h4>
                        <p>No se pudieron cargar los convenios. Detalle: ${error.message}</p>
                    </div>
                `;
                rubroGridLoading.classList.add('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Rellena el grid de rubros únicos y añade la opción TODOS.
         */
        function populateRubroGrid(convenios) {
            rubroGridLoading.classList.add('hidden');
            rubroGrid.innerHTML = '';
            uniqueRubros = new Set();

            convenios.forEach(c => {
                if (c.rubro) {
                    uniqueRubros.add(c.rubro.toUpperCase().trim());
                }
            });
            
            let rubrosArray = Array.from(uniqueRubros).sort();

            // Agregar la opción "TODOS" al principio
            if (!rubrosArray.includes('TODOS')) {
                rubrosArray.unshift('TODOS');
            }

            renderRubroGrid(rubrosArray);
        }
        
        /**
         * Devuelve un color de acento y un color de fondo pastel para el tile del rubro.
         */
        function getRubroColor(rubro) {
            const r = rubro.toUpperCase().trim();
            // Colores tipo Bootstrap para los iconos, con un fondo muy suave
            switch (r) {
                case 'TODOS': return { color: 'var(--color-stm-purple)', bg: '#f1f1f9' };
                case 'SALUD': case 'MEDICINA': return { color: 'var(--color-rubro-danger)', bg: '#fef3f4' }; 
                case 'EDUCACION': case 'FORMACION': return { color: 'var(--color-rubro-primary)', bg: '#f0f6ff' };
                case 'TURISMO': case 'VIAJES': return { color: 'var(--color-rubro-success)', bg: '#f0fff4' };
                case 'DEPORTES': case 'GIMNASIOS': return { color: 'var(--color-stm-teal)', bg: '#f0fbff' }; 
                case 'COMERCIO': case 'COMPRAS': return { color: 'var(--color-rubro-warning)', bg: '#fffaf0' };
                case 'GASTRONOMIA': case 'COMIDA': return { color: 'var(--color-rubro-secondary)', bg: '#f8f9fa' };
                case 'SERVICIOS': return { color: 'var(--color-rubro-primary)', bg: '#f0f6ff' }; 
                case 'BELLEZA': case 'ESTETICA': return { color: 'var(--color-rubro-info)', bg: '#f0fdff' };
                case 'FINANZAS': return { color: 'var(--color-rubro-success)', bg: '#f0fff4' };
                case 'LEGAL': return { color: 'var(--color-rubro-secondary)', bg: '#f8f9fa' };
                default: return { color: 'var(--color-stm-teal)', bg: '#f0fbff' };
            }
        }
        
        /**
         * Devuelve el icono de Font Awesome 6 (ahora más específicos) para el rubro.
         */
        function getRubroIcon(rubro) {
            const r = rubro.toUpperCase().trim();
            switch (r) {
                case 'TODOS': return '<i class="fas fa-layer-group"></i>';
                case 'SALUD': case 'MEDICINA': return '<i class="fas fa-notes-medical"></i>'; 
                case 'EDUCACION': case 'FORMACION': return '<i class="fas fa-graduation-cap"></i>';
                case 'TURISMO': case 'VIAJES': return '<i class="fas fa-plane-departure"></i>'; 
                case 'DEPORTES': case 'GIMNASIOS': return '<i class="fas fa-dumbbell"></i>'; 
                case 'COMERCIO': case 'COMPRAS': return '<i class="fas fa-store"></i>'; 
                case 'GASTRONOMIA': case 'COMIDA': return '<i class="fas fa-burger"></i>'; 
                case 'SERVICIOS': return '<i class="fas fa-screwdriver-wrench"></i>'; 
                case 'BELLEZA': case 'ESTETICA': return '<i class="fas fa-spa"></i>'; 
                case 'FINANZAS': return '<i class="fas fa-sack-dollar"></i>'; 
                case 'LEGAL': return '<i class="fas fa-gavel"></i>'; 
                default: return '<i class="fas fa-handshake"></i>'; 
            }
        }

        /**
         * Renderiza la grilla de tarjetas de rubros.
         */
        function renderRubroGrid(rubros) {
            rubroGridLoading.classList.add('hidden');
            rubroGrid.innerHTML = '';
            
            rubros.forEach(rubro => {
                const rubroName = rubro;
                const rubroIconHTML = getRubroIcon(rubro); 
                const rubroStyle = getRubroColor(rubro);

                const card = document.createElement('div');
                card.className = 'col-span-1';
                card.innerHTML = `
                    <div class="rubro-tile ${rubro === currentFilter ? 'active' : ''} active:scale-[0.99] transition-transform" data-rubro="${rubro}">
                        <!-- Círculo de Icono sólido -->
                        <div class="rubro-icon-bg" 
                             style="background-color: ${rubroStyle.bg}; color: ${rubroStyle.color};">
                            ${rubroIconHTML}
                        </div>
                        <!-- Texto del rubro ahora usa el color del rubroStyle -->
                        <p class="text-[0.7rem] font-medium uppercase leading-tight mt-1 px-0.5 text-gray-700">
                           ${rubroName}
                        </p>
                    </div>
                `;
                
                // Asigna la función de filtro al hacer click
                card.querySelector('.rubro-tile').onclick = function() {
                    currentFilter = rubro;
                    filterConvenios(rubro, true);
                    // Actualiza la clase activa y los estilos de borde
                    document.querySelectorAll('.rubro-tile').forEach(tile => tile.classList.remove('active'));
                    this.classList.add('active');
                };
                
                rubroGrid.appendChild(card);
            });
        }
        
        /**
         * Filtra los convenios basados en la selección del rubro y actualiza la vista.
         */
        function filterConvenios(selectedRubro, shouldFlip = false) {
            currentFilter = selectedRubro;
            let filteredConvenios = [];

            if (selectedRubro === 'TODOS') {
                filteredConvenios = allConvenios;
                conveniosTitle.textContent = "Convenios Destacados:";
            } else {
                filteredConvenios = allConvenios.filter(c => 
                    (c.rubro || '').toUpperCase().trim() === selectedRubro
                );
                conveniosTitle.textContent = `Convenios en: ${selectedRubro}`;
            }

            renderConvenios(filteredConvenios);
            
            if (shouldFlip) {
                flipTo('back');
            }
        }

        /**
         * Renderiza la lista de convenios en formato de acordeón.
         */
        function renderConvenios(convenios) {
            conveniosList.innerHTML = '';
            
            document.querySelectorAll('.convenio-card.open').forEach(openCard => {
                openCard.classList.remove('open');
            });
            
            if (convenios.length === 0) {
                noResults.classList.remove('hidden');
                conveniosList.classList.add('hidden'); 
                return;
            }
            noResults.classList.add('hidden');
            conveniosList.classList.remove('hidden');

            convenios.forEach(convenio => {
                const rubro = (convenio.rubro || 'SIN RUBRO').toUpperCase().trim();
                const titulo = convenio.titulo || 'Convenio sin Título';
                const detalle = (convenio.detalle || 'Detalle no especificado.').replace(/\n/g, '<br>'); 
                const rubroIconHTML = getRubroIcon(rubro); 
                const rubroColor = getRubroColor(rubro).color; // Color de acento

                const card = document.createElement('div');
                card.className = 'convenio-card'; 

                card.onclick = function() {
                    toggleConvenio(this);
                };

                card.innerHTML = `
                    <div class="p-4 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition duration-150">
                        <!-- Lado Izquierdo: Rubro y Título -->
                        <div class="flex-1 min-w-0 pr-4">
                            <!-- Tag Púrpura principal, más simple -->
                            <span class="rubro-tag inline-flex items-center px-2 py-0.5 text-xs font-medium uppercase tracking-wider rounded-md text-white mb-1">
                                <span class="mr-1 text-sm">${rubroIconHTML}</span> ${rubro} 
                            </span>
                            <!-- Título con fuente Roboto y más simple -->
                            <h2 class="text-xl font-bold text-gray-900">${titulo}</h2>
                        </div>
                        
                        <!-- Lado Derecho: Icono de Despliegue Púrpura -->
                        <div class="flex-shrink-0">
                            <i class="fas fa-chevron-down chevron text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Contenido Desplegable (Detalle) -->
                    <div class="convenio-content">
                        <div class="text-base text-gray-700 leading-relaxed">
                            <!-- Detalle del beneficio con color de acento del rubro -->
                            <h3 class="font-bold mb-3 border-b border-gray-200 pb-1 text-lg" style="color: ${rubroColor};">Detalles y Beneficios:</h3>
                            <p class="text-sm">${detalle}</p>
                        </div>
                    </div>
                `;
                conveniosList.appendChild(card);
            });
        }
        
        /**
         * Abre o cierra la tarjeta de convenio y cierra las otras abiertas.
         */
        function toggleConvenio(card) {
            const isOpen = card.classList.contains('open');

            // 1. Cerrar todas las otras tarjetas abiertas
            document.querySelectorAll('.convenio-card.open').forEach(openCard => {
                if (openCard !== card) {
                    openCard.classList.remove('open');
                }
            });

            // 2. Abrir/Cerrar la tarjeta actual
            if (!isOpen) {
                card.classList.add('open');
            } else {
                card.classList.remove('open');
            }
        }
    </script>
</body>
</html>