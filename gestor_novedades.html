<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top"> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Novedades - STM</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CONSTANTES DE COLOR DE consulta.html */
        :root {
            --stm-purple: #5A377B; /* P√∫rpura principal (Guardar/Gestor Novedades) */
            --stm-teal: #34B3C5;   /* Turquesa (Crear Novedad) */
            --stm-red: #dc3545;    /* Rojo (Eliminar) */
            --stm-indigo: #4f46e5; /* √çndigo del dashboard (Cabecera de Tabla) */
            --stm-dark-purple: #492a63; /* Variante oscura del p√∫rpura para hover */
        }

        body { 
            background-color: #eef2f7; /* Fondo del dashboard */
            font-size: 15px;
            font-family: 'Roboto', sans-serif; 
        }
        .main-container {
            max-width: 1100px; 
            margin: 30px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 4px solid var(--stm-indigo); /* Borde superior como el dashboard */
        }
        
        /* ESTILOS DEL NUEVO ENCABEZADO (COMO EL DASHBOARD) */
        .logo-container {
            /* Flexbox para alinear el logo y el texto horizontalmente */
            display: flex; 
            align-items: center; /* Centrado vertical */
            justify-content: space-between; /* Espacio entre el t√≠tulo y el bot√≥n */
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0; /* Separador sutil */
        }
        
        .header-content {
            display: flex;
            align-items: center;
        }

        .logo-container img {
            max-width: 60px; /* Reducido para que se parezca m√°s al dashboard */
            height: auto; 
            border-radius: 50%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-right: 15px; /* Espacio entre el logo y el texto */
        }

        .header-title {
            /* Nuevo estilo para el t√≠tulo grande junto al logo */
            font-size: 1.8rem; /* Tama√±o grande */
            font-weight: 700;
            color: #1f2937; /* Color oscuro */
            margin: 0; /* Sin m√°rgenes predeterminados */
        }
        
        /* --- BOTONES --- */
        
        /* BOT√ìN CREAR (Turquesa - stm-teal) */
        .btn-stm-create {
            background-color: var(--stm-teal); 
            border-color: var(--stm-teal); 
            color: #ffffff; 
            font-weight: 600;
            padding: 10px 20px; 
            border-radius: 50px; 
            box-shadow: 0 4px 15px -3px rgba(52, 179, 197, 0.5); 
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-create:hover, 
        .btn-stm-create:focus {
            background-color: #2a8e9b; 
            border-color: #2a8e9b;
            color: #ffffff;
            transform: translateY(-2px); 
            box-shadow: 0 6px 18px -3px rgba(52, 179, 197, 0.7);
        }

        /* BOT√ìN GUARDAR (P√∫rpura - stm-purple) */
        .btn-stm-save {
            background-color: var(--stm-purple); 
            border-color: var(--stm-purple); 
            color: #ffffff;
            font-weight: 600;
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(90, 55, 123, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-save:hover, 
        .btn-stm-save:focus {
            background-color: var(--stm-dark-purple); 
            border-color: var(--stm-dark-purple);
            color: #ffffff;
            transform: translateY(-1px);
        }

        /* BOT√ìN 'Tablero de mando' */
        .btn-dashboard {
            background-color: var(--stm-purple); 
            border-color: var(--stm-dark-purple); 
            color: #ffffff;
            font-weight: 600;
            padding: 8px 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(90, 55, 123, 0.4);
            transition: all 0.2s ease-in-out;
            text-decoration: none; /* Asegurar que no tenga subrayado */
        }
        .btn-dashboard:hover,
        .btn-dashboard:focus {
            background-color: var(--stm-dark-purple); 
            border-color: var(--stm-dark-purple);
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        /* BOT√ìN ELIMINAR (Rojo - stm-red) */
        .btn-stm-delete {
            background-color: var(--stm-red); 
            border-color: var(--stm-red); 
            color: #ffffff; 
            border-radius: 8px; 
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-delete:hover, 
        .btn-stm-delete:focus {
            background-color: #b02a37;
            border-color: #b02a37;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        /* --- TABLA --- */
        .table-responsive {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .table thead {
            background-color: var(--stm-indigo);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table th {
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        #loadingSpinner {
            text-align: center;
            padding: 40px;
        }
        
        .table-hover tbody tr {
            cursor: pointer;
        }
        .table-hover tbody tr:hover {
            background-color: #f0f4f9; 
        }

        .activo-icon {
            font-size: 1.2rem;
            display: block;
            text-align: center;
        }
        .text-success { color: #28a745 !important; } 
        .text-danger { color: #dc3545 !important; } 

        .table th.col-activo {
            width: 1%;
            text-align: center;
        }
        .table td.col-activo {
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="main-container">
            
            <div class="logo-container">
                <div class="header-content">
                    <img src="logo_STM.png" alt="Logo Sindicato de Trabajadores Municipales">
                    
                    <h1 class="header-title">
                        üì¢ Gestor de <span style="color: var(--stm-indigo);">Novedades</span>
                    </h1>
                </div>

                <a href="dashboard.html" class="btn btn-dashboard">
                    <i class="fas fa-chart-line me-2"></i> Tablero de mando
                </a>
            </div>
            
            <div class="d-flex justify-content-end mb-4">
                <button type="button" class="btn btn-stm-create" onclick="openModal()">
                    <i class="fas fa-plus-circle me-2"></i> Crear Nueva Novedad
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col" class="col-activo">ACTIVO</th>
                            <th scope="col">T√≠tulo</th>
                            <th scope="col">Fecha</th>
                            <th scope="col">Contenido</th>
                        </tr>
                    </thead>
                    <tbody id="novedadesTableBody">
                    </tbody >
                </table>
                <div id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando novedades...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando novedades...</p>
                </div>
            </div>

        </div>
    </div>
    
    <div class="modal fade" id="novedadModal" tabindex="-1" aria-labelledby="novedadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="novedadForm" novalidate class="needs-validation"> 
                    <div class="modal-header">
                        <h5 class="modal-title" id="novedadModalLabel">Crear Novedad</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="inputIdNovedad" name="ID">
                        
                        <div class="mb-3">
                            <label for="inputTitulo" class="form-label">
                                T√≠tulo: <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="inputTitulo" name="Titulo" required>
                            <div class="invalid-feedback">
                                Por favor, ingres√° un t√≠tulo para la novedad.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="inputFecha" class="form-label">
                                Fecha novedad: <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" id="inputFecha" name="Fecha" required>
                            <div class="invalid-feedback">
                                Por favor, seleccion√° una fecha.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="textareaContenido" class="form-label d-flex justify-content-between">
                                <span>Contenido: <span class="text-danger">*</span></span>
                                <span class="text-muted small" id="charCount">0/1000 caracteres</span>
                            </label>
                            <textarea class="form-control" id="textareaContenido" name="Contenido" rows="6" required maxlength="1000"></textarea>
                            <div class="invalid-feedback">
                                Por favor, ingres√° el contenido de la novedad (m√°ximo 1000 caracteres).
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="inputActivo" name="Activo" value="SI">
                            <label class="form-check-label" for="inputActivo">
                                ¬øNovedad Activa? (Marcar para mostrar)
                            </label>
                        </div>
                        
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <button type="button" class="btn btn-stm-delete" id="btnEliminarEnModal" style="display: none;">
                            <i class="fas fa-trash-alt me-2"></i> Eliminar Novedad
                        </button>
                        
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelarModal">Cancelar</button>
                            <button type="submit" class="btn btn-stm-save" id="btnGuardar">Guardar Novedad</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">‚ö†Ô∏è Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro/a que quer√©s eliminar la novedad con ID: <strong id="deleteNovedadId" class="text-danger"></strong>?</p>
                    <p class="text-danger">¬°Esta acci√≥n no se puede deshacer!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-stm-delete" id="btnAceptarEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">Resultado de la Operaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="feedbackModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        
        // --- üö® C√ìDIGO DE VERIFICACI√ìN DE SEGURIDAD üö® ---
        // Chequea si la bandera de autenticaci√≥n existe en el localStorage
        if (localStorage.getItem('isAuthenticatedSTM') !== 'true') {
            // Si no est√° autenticado, redirigir al login
            window.location.href = 'index.html';
        }
        // --- FIN C√ìDIGO DE VERIFICACI√ìN ---
        
        // L√ìGICA DE JAVASCRIPT
        const APPSSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxfNlhTU4hO8linQddyhVvd5rTrsAQxx1XvlsJO5tbBvUeyzczi1q-LbwU6-dSsLPvt9w/exec'; 

        const novedadesTableBody = document.getElementById('novedadesTableBody');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        const novedadForm = document.getElementById('novedadForm');
        const novedadModal = new bootstrap.Modal(document.getElementById('novedadModal'));
        const novedadModalLabel = document.getElementById('novedadModalLabel');
        const btnGuardar = document.getElementById('btnGuardar');
        const btnCancelarModal = document.getElementById('btnCancelarModal'); 
        
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const btnAceptarEliminar = document.getElementById('btnAceptarEliminar');
        const btnEliminarEnModal = document.getElementById('btnEliminarEnModal'); 
        
        const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const feedbackModalBody = document.getElementById('feedbackModalBody');
        
        const textareaContenido = document.getElementById('textareaContenido');
        const charCountElement = document.getElementById('charCount');


        let novedadIdToDelete = null;

        let originalGuardarText = '';
        let originalEliminarText = '';


        document.addEventListener('DOMContentLoaded', () => {
            originalGuardarText = btnGuardar.textContent;
            originalEliminarText = btnAceptarEliminar.textContent;
            fetchNovedades();
        });

        // Evento para actualizar el contador de caracteres al escribir
        textareaContenido.addEventListener('input', () => {
            const currentLength = textareaContenido.value.length;
            const maxLength = textareaContenido.getAttribute('maxlength');
            charCountElement.textContent = `${currentLength}/${maxLength} caracteres`;
            
            // Opcional: Cambiar color si se acerca al l√≠mite o se excede (aunque maxlength lo previene)
            if (currentLength >= maxLength * 0.9) {
                charCountElement.classList.remove('text-muted');
                charCountElement.classList.add('text-danger');
            } else {
                charCountElement.classList.remove('text-danger');
                charCountElement.classList.add('text-muted');
            }
        });


        novedadForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Validaci√≥n de Bootstrap 5 para campos requeridos
            if (!novedadForm.checkValidity()) {
                event.stopPropagation();
                novedadForm.classList.add('was-validated');
                return; // Detiene la ejecuci√≥n si hay campos inv√°lidos
            }
            
            // Validaci√≥n de longitud del contenido (Aunque maxlength en HTML ayuda, es buena pr√°ctica)
            if (textareaContenido.value.length > 1000) {
                 // Si por alguna raz√≥n el maxlength falla (ej: copy-paste masivo), notificamos
                showFeedback('El contenido excede el l√≠mite de 1000 caracteres.', false);
                return;
            }

            const id = document.getElementById('inputIdNovedad').value;
            const accion = id ? 'ACTUALIZAR' : 'CREAR';
            await manejarEnvio(accion, id);
        });

        // Evento para el nuevo bot√≥n "Eliminar Novedad" dentro del modal de edici√≥n
        btnEliminarEnModal.addEventListener('click', function() {
            const id = document.getElementById('inputIdNovedad').value;
            if (id) {
                // Cerramos el modal de edici√≥n y abrimos el de confirmaci√≥n
                novedadModal.hide(); 
                showDeleteConfirm(id);
            }
        });

        btnAceptarEliminar.addEventListener('click', async function() {
            if (novedadIdToDelete) {
                setLoadingState(true, 'ELIMINAR');
                confirmDeleteModal.hide();
                await manejarEnvio('ELIMINAR', novedadIdToDelete);
                novedadIdToDelete = null; 
            }
        });

        /**
         * Maneja el estado de carga de los botones principales del CRUD.
         * @param {boolean} isLoading - Si debe entrar en estado de carga (true) o salir (false).
         * @param {string} [accion] - Opcional. 'GUARDAR' o 'ELIMINAR'.
         */
        function setLoadingState(isLoading, accion) {
            const isGuardar = !accion || accion === 'GUARDAR';
            const isEliminar = accion === 'ELIMINAR';

            if (isGuardar) {
                btnGuardar.disabled = isLoading;
                btnCancelarModal.disabled = isLoading; 
                btnEliminarEnModal.disabled = isLoading; // Deshabilita tambi√©n el nuevo bot√≥n de eliminar

                if (isLoading) {
                    btnGuardar.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Aguarde...
                    `;
                    // A√±adimos la clase d-flex para que el spinner y texto queden centrados si hace falta
                    btnGuardar.classList.add('d-flex', 'align-items-center', 'justify-content-center'); 
                } else {
                    btnGuardar.textContent = originalGuardarText;
                    btnGuardar.classList.remove('d-flex', 'align-items-center', 'justify-content-center'); 
                }
            }

            if (isEliminar) {
                btnAceptarEliminar.disabled = isLoading;

                if (isLoading) {
                    btnAceptarEliminar.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Aguarde...
                    `;
                    btnAceptarEliminar.classList.add('d-flex', 'align-items-center', 'justify-content-center');
                } else {
                    btnAceptarEliminar.textContent = originalEliminarText;
                    btnAceptarEliminar.classList.remove('d-flex', 'align-items-center', 'justify-content-center');
                }
            }
        }


        function renderTable(novedades) {
            novedadesTableBody.innerHTML = '';
            loadingSpinner.style.display = 'none';
            const COLSPAN_COUNT = 4; 

            if (novedades.length === 0) {
                novedadesTableBody.innerHTML = `
                    <tr>
                        <td colspan="${COLSPAN_COUNT}" class="text-center py-4 text-muted"> 
                            A√∫n no hay novedades cargadas. ¬°Cre√° la primera!
                        </td>
                    </tr>
                `;
                return;
            }

            novedades.forEach(novedad => {
                const isActive = (novedad.Activo || '').toUpperCase().trim() === 'SI'; 
                
                const activoIcono = isActive 
                    ? '<i class="activo-icon fas fa-check-circle text-success" title="Activo"></i>' 
                    : '<i class="activo-icon fas fa-times-circle text-danger" title="No Activo"></i>';
                
                const row = novedadesTableBody.insertRow();
                row.setAttribute('onclick', `openModal(
                    '${novedad.ID}', 
                    '${novedad.Titulo.replace(/'/g, "\\'")}', 
                    '${novedad.Fecha}', 
                    \`${novedad.Contenido.replace(/`/g, '\\`')}\`,
                    '${novedad.Activo}' 
                )`);

                row.innerHTML = `
                    <td class="col-activo">${activoIcono}</td>
                    <td>${novedad.Titulo}</td>
                    <td>${novedad.Fecha}</td>
                    <td>${novedad.Contenido.substring(0, 50).trim()}${novedad.Contenido.length > 50 ? '...' : ''}</td>
                `;
            });
        }

        function openModal(id = '', titulo = '', fecha = '', contenido = '', activo = 'SI') {
            novedadForm.reset(); 
            novedadForm.classList.remove('was-validated'); 
            
            const inputIdNovedad = document.getElementById('inputIdNovedad');
            const inputTitulo = document.getElementById('inputTitulo');
            const inputFecha = document.getElementById('inputFecha'); 
            const inputActivo = document.getElementById('inputActivo');
            
            inputIdNovedad.value = id;

            if (id) {
                // Modo Edici√≥n
                novedadModalLabel.textContent = 'Editar Novedad';
                originalGuardarText = 'Guardar Cambios';
                
                inputTitulo.value = titulo;
                inputFecha.value = fecha;
                textareaContenido.value = contenido;
                inputActivo.checked = (activo || '').toUpperCase().trim() === 'SI'; 
                
                btnEliminarEnModal.style.display = 'block'; 
                
            } else {
                // Modo Creaci√≥n
                novedadModalLabel.textContent = 'Crear Nueva Novedad';
                originalGuardarText = 'Guardar Novedad';
                inputActivo.checked = true; 

                btnEliminarEnModal.style.display = 'none'; 

                // Poner la fecha actual por defecto
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0'); 
                const dd = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${yyyy}-${mm}-${dd}`;
                inputFecha.value = formattedDate; 
            }
            
            // Actualizar el contador de caracteres al abrir el modal
            const currentLength = textareaContenido.value.length;
            const maxLength = textareaContenido.getAttribute('maxlength');
            charCountElement.textContent = `${currentLength}/${maxLength} caracteres`;


            setLoadingState(false, 'GUARDAR');

            novedadModal.show();
        }

        function showDeleteConfirm(id) {
            novedadIdToDelete = id;
            document.getElementById('deleteNovedadId').textContent = id;
            setLoadingState(false, 'ELIMINAR');
            confirmDeleteModal.show();
        }

        function showFeedback(message, success = true) {
            const title = success ? '‚úÖ ¬°Operaci√≥n Exitosa!' : '‚ùå ¬°Error!';
            const header = document.getElementById('feedbackModal').querySelector('.modal-header');
            const titleEl = document.getElementById('feedbackModalLabel');
            
            titleEl.textContent = title;
            feedbackModalBody.innerHTML = `<p>${message}</p>`;

            // Cambiar el color del header del modal de feedback
            header.classList.remove('bg-danger', 'bg-success', 'text-white');
            if (success) {
                header.classList.add('bg-success', 'text-white'); 
            } else {
                header.classList.add('bg-danger', 'text-white'); 
            }
            document.getElementById('feedbackModal').querySelector('.btn-close').classList.add('btn-close-white');


            feedbackModal.show();
        }


        async function fetchNovedades() {
            loadingSpinner.style.display = 'block';
            novedadesTableBody.innerHTML = ''; 

            try {
                const response = await fetch(APPSSCRIPT_URL + '?action=READ_ALL');
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && Array.isArray(data.novedades)) {
                        renderTable(data.novedades);
                    } else {
                        throw new Error(data.message || 'Error en el formato de datos devueltos.');
                    }
                } else {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                loadingSpinner.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        Error al cargar las novedades: ${error.message}
                        <br>Revis√° la configuraci√≥n de tu AppScript.
                    </div>
                `;
                console.error('Error al cargar novedades:', error);
            }
        }

        async function manejarEnvio(accion, id) {
            let method, body, apiUrl, successMessage;

            setLoadingState(true, accion === 'ELIMINAR' ? 'ELIMINAR' : 'GUARDAR');
            
            const formData = new FormData(novedadForm); 
            
            const inputActivo = document.getElementById('inputActivo');
            if (!inputActivo.checked) {
                formData.set('Activo', 'NO'); 
            } else {
                 formData.set('Activo', 'SI');
            }

            switch (accion) {
                case 'CREAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    formData.append('action', 'CREATE');
                    body = formData;
                    successMessage = 'La novedad se cre√≥ exitosamente.';
                    break;
                case 'ACTUALIZAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    formData.append('action', 'UPDATE');
                    formData.append('ID', id);
                    body = formData;
                    successMessage = `La novedad se actualiz√≥ correctamente.`;
                    break;
                case 'ELIMINAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    const deleteData = new FormData();
                    deleteData.append('action', 'DELETE');
                    deleteData.append('ID', id);
                    body = deleteData;
                    successMessage = `La novedad fue eliminada.`;
                    break;
                default:
                    showFeedback('Acci√≥n desconocida.', false);
                    return;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: method,
                    body: body 
                });

                const responseText = await response.text();
                let result = {};
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    // Si el AppScript no devuelve JSON pero la respuesta fue 200 (√©xito en la ejecuci√≥n de la funci√≥n)
                    if (responseText.includes('Error')) {
                        throw new Error('Error desconocido del servidor de AppScript.');
                    }
                    result = { status: 'success' };
                }

                if (response.ok && result.status === 'success') {
                    novedadModal.hide();
                    showFeedback(successMessage, true);
                    await fetchNovedades();
                } else {
                    const errorDetail = result.message || 'Error en la operaci√≥n en la planilla.';
                    throw new Error(errorDetail);
                }

            } catch (error) {
                if (accion !== 'ELIMINAR') {
                    novedadModal.hide();
                }
                showFeedback(`¬°Error al ejecutar la operaci√≥n! Detalle: ${error.message}`, false);
                console.error(`Error de ${accion}:`, error);
            } finally {
                setLoadingState(false, accion === 'ELIMINAR' ? 'ELIMINAR' : 'GUARDAR');
            }
        }

    </script>
</body>
</html>