<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Novedades STM</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* Estilos base ajustados */
    body { 
        background:#f4f4f4; 
        padding: 5px 20px 20px 20px;
        font-family:Roboto, sans-serif; 
    }
    
    .carousel-item { 
        height: auto; /* Mantenemos 'auto' */
        min-height: 0; /* <--- ¡CORRECCIÓN CLAVE! Eliminamos el mínimo fijo para que se adapte. */
        max-height: 550px;
        background:#444; 
        color:white; 
        position:relative;
        display: flex;
        align-items: center;
    }

    .carousel-inner {
        /* Agregado para forzar la adaptación del contenedor principal */
        height: auto !important; 
    }

    .carousel-item img { 
        object-fit: cover; 
        width: 100%; 
        height: 100%; 
        position: absolute; 
        opacity: 0.55; 
    }

    /* Estilos para el nuevo contenedor de flechas */
    .carousel-controls-bottom {
        display: flex; /* Para poner los botones uno al lado del otro */
        justify-content: center; /* Para centrarlos */
        gap: 15px; /* Espacio entre los botones */
        margin-top: 15px; /* Espacio arriba del control */
    }

    /* Estilo de los botones de navegación inferiores */
    .btn-carousel-nav {
        background-color: #5d3f6a; /* Color principal del STM */
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        font-size: 1.2rem;
        line-height: 1; 
        display: flex; 
        align-items: center;
        text-decoration: none;
    }

    /* Estilos del ícono de Bootstrap que usamos para las flechas */
    .btn-carousel-nav .bi {
        font-size: 1.5rem;
    }
    
    /* ******************************************************************* */
    /* EL CAPTION (Contenedor blanco) */
    .carousel-caption { 
        z-index: 10;
        position: static;
        color: #333;
        background-color: white;
        padding: 20px;
        margin: 0;
        border-radius: 8px;
        text-align: center;
        width: 100%;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
    }

    /* Estilo para la FECHA (nueva ubicación: arriba del título) */
    .carousel-caption .fecha-novedad {
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 5px; /* Espacio antes del título */
        display: block; 
    }
    
    /* Estilo para el TÍTULO */
    .carousel-caption h3 {
        color: #5d3f6a;
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 10px; 
    }
    
    /* Estilo para la DESCRIPCIÓN */
    .carousel-caption p {
        font-size: 0.95rem;
        line-height: 1.4;
        color: #555;
    }
    
    .logo-container { text-align: center; margin-bottom: 5px; } 
    .logo-container img { max-width: 100px; height: auto; }
</style>
</head>
<body>

<div class="logo-container">
    <img src="logo_STM.png" alt="Logo Sindicato de Trabajadores Municipales de General Pueyrredon">
</div>

<h2 class="text-center mb-4">⚠️ Novedades STM</h2>

<div id="novedadesCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-indicators" id="carouselIndicators"></div>
    <div class="carousel-inner" id="carouselInner">
        <div class="carousel-item active">
            <div class="carousel-caption">
                <h3>Cargando novedades…</h3>
            </div>
        </div>
    </div>
</div>

<div class="carousel-controls-bottom">
    <button class="btn-carousel-nav" type="button" data-bs-target="#novedadesCarousel" data-bs-slide="prev">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
        </svg>
    </button>
    <button class="btn-carousel-nav" type="button" data-bs-target="#novedadesCarousel" data-bs-slide="next">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
        </svg>
    </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ID de publicación de Google Sheets (Publicar > Web)
const SHEET_ID = "1OZnWCvh9NpBaoZndAV1IPPqtNWgQnv8GMh6J2-l3wZo";
const GID = "195669740";
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

/**
 * Convierte el formato de fecha de Google Sheets a DD de mes de YYYY.
 * Soporta:
 * 1. String DD/MM/YYYY o DD-MM-YYYY (ej: 11/05/2025)
 * 2. Formato de función Date() de Sheets (ej: Date(2025, 4, 11) donde 4=Mayo)
 * @param {string} dateString El string de la fecha.
 * @returns {string} La fecha formateada, o el texto original si es inválida.
 */
function formatDate(dateString) {
    let date;
    
    // 1. Intentar parsear el formato String DD/MM/YYYY o DD-MM-YYYY (de la imagen que subiste)
    const stringMatch = dateString.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
    if (stringMatch) {
        // Formato: DD / MM / YYYY
        const day = parseInt(stringMatch[1], 10);
        const month = parseInt(stringMatch[2], 10); // 1-12
        const year = parseInt(stringMatch[3], 10);
        
        // Creamos la fecha: new Date(Año, Índice del Mes, Día)
        // JS requiere: Mes (0-11), Día. Restamos 1 al mes.
        date = new Date(year, month - 1, day);
        
    } else {
        // 2. Intentar parsear el formato Date(Y, X, Z) de Google Sheets (por si acaso)
        // [1]=Año, [2]=Valor 1, [3]=Valor 2
        const vizMatch = dateString.match(/Date\((\d{4}),(\d{1,2}),(\d{1,2})\)/);
        if (vizMatch) {
            // Asumiendo la corrección de swap de Mes/Día que hicimos antes
            const year = parseInt(vizMatch[1]);
            const day = parseInt(vizMatch[2]);         // Corregido: Día es la segunda posición (ej: 11)
            const monthIndex = parseInt(vizMatch[3]);  // Corregido: Mes (0-11) es la tercera posición (ej: 4 para Mayo)
            
            // Creamos la fecha: new Date(Año, Índice del Mes, Día)
            date = new Date(year, monthIndex, day);
        } else {
            // 3. Intento de parseo estándar de JS para otros formatos.
            date = new Date(dateString);
        }
    }
    
    // Verificar si la fecha es válida
    if (isNaN(date.getTime())) {
        console.error("Fecha inválida recibida:", dateString);
        return dateString; // Devolver el texto original si no se puede formatear
    }

    // Opciones de formato: DD de MesLargo de YYYY
    const options = { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
    };

    // Usamos Intl.DateTimeFormat para garantizar el español (es-AR)
    const formatter = new Intl.DateTimeFormat('es-AR', options);
    let formattedDate = formatter.format(date);
    
    // Eliminamos cualquier punto o coma que pudiera haber quedado (como 10 de junio, 2025)
    formattedDate = formattedDate.replace(/\./g, '').replace(/,/g, '').trim();

    return formattedDate;
}

function parseData(text) {
    const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
    const rows = json.table.rows;
    return rows
        .map(r => {
            const c = r.c;
            // ATENCIÓN: Columnas basadas en la última imagen que subiste
            // B (c[1]): titulo
            // C (c[2]): Descripción
            // D (c[3]): fecha_novedad 
            // E (c[4]): ACTIVO 
            return {
                titulo: c[1]?.v || "",  
                desc: c[2]?.v || "",    
                // Usamos el valor formateado (f) si existe, si no, el valor crudo (v)
                fecha: c[3]?.f || c[3]?.v || "", 
                img: null,              
                activo: (c[4]?.v || "").toString().toUpperCase() === "SI" 
            };
        })
        .filter(r => r.activo);
}

async function loadData() {
    const inner = document.getElementById("carouselInner");
    const indicators = document.getElementById("carouselIndicators");
    inner.innerHTML = "";
    indicators.innerHTML = "";

    try {
        const res = await fetch(URL);
        const text = await res.text();
        if (!text.includes("google.visualization")) throw new Error("Hoja no publicada o permisos insuficientes.");

        const novedades = parseData(text);
        if (novedades.length === 0) {
            inner.innerHTML = `<div class="carousel-item active"><div class="carousel-caption"><h3>Sin novedades activas</h3></div></div>`;
            return;
        }

        novedades.forEach((n, i) => {
            // Formateamos la fecha antes de insertarla
            const fechaFormateada = formatDate(n.fecha);
            
            // indicadores
            const ind = document.createElement("button");
            ind.type = "button";
            ind.dataset.bsTarget = "#novedadesCarousel";
            ind.dataset.bsSlideTo = i;
            if (i === 0) ind.classList.add("active");
            indicators.appendChild(ind);

            // item
            const item = document.createElement("div");
            item.className = "carousel-item" + (i === 0 ? " active" : "");

            // La imagen ya no se carga, usamos solo el fondo oscuro por defecto
            
            const cap = document.createElement("div");
            cap.className = "carousel-caption";
            
            // Insertamos la fecha formateada
            cap.innerHTML = `
                <span class="fecha-novedad">Fecha de la novedad: ${fechaFormateada}</span>
                <h3>${n.titulo}</h3>
                <p>${n.desc}</p>
            `; 
            item.appendChild(cap);
            inner.appendChild(item);
        });

        // Este código asegura que Bootstrap recalcule la altura después de cargar los datos
        const carousel = new bootstrap.Carousel(document.getElementById('novedadesCarousel'));
        carousel.cycle();

    } catch (e) {
        inner.innerHTML = `<div class="carousel-item active"><div class="carousel-caption"><h3>Error al cargar</h3><p>${e.message}</p></div></div>`;
    }
}

document.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>