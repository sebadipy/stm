<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top"> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Novedades - STM</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome para los √≠conos (tilde verde / cruz roja) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CONSTANTES DE COLOR DE consulta.html */
        :root {
            --stm-purple: #5A377B; /* P√∫rpura principal (Guardar/Gestor Novedades) */
            --stm-teal: #34B3C5;   /* Turquesa (Crear Novedad) */
            --stm-red: #dc3545;    /* Rojo (Eliminar) */
            --stm-indigo: #4f46e5; /* √çndigo del dashboard (Cabecera de Tabla) */
        }

        body { 
            background-color: #eef2f7; /* Fondo del dashboard */
            font-size: 15px;
            font-family: 'Roboto', sans-serif; 
        }
        .main-container {
            max-width: 1100px; 
            margin: 30px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 4px solid var(--stm-indigo); /* Borde superior como el dashboard */
        }
        .logo-container {
            text-align: left; 
            margin-bottom: 20px; 
        }
        .logo-container img {
            max-width: 100px; 
            height: auto; 
            border-radius: 50%; /* Redondeo del logo */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* BOT√ìN CREAR (Turquesa - stm-teal) */
        .btn-stm-create {
            background-color: var(--stm-teal); 
            border-color: var(--stm-teal); 
            color: #ffffff; 
            font-weight: 600;
            padding: 10px 20px; 
            border-radius: 50px; 
            box-shadow: 0 4px 15px -3px rgba(52, 179, 197, 0.5); 
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-create:hover, 
        .btn-stm-create:focus {
            background-color: #2a8e9b; 
            border-color: #2a8e9b;
            color: #ffffff;
            transform: translateY(-2px); 
            box-shadow: 0 6px 18px -3px rgba(52, 179, 197, 0.7);
        }

        /* BOT√ìN GUARDAR (P√∫rpura - stm-purple) */
        .btn-stm-save {
            background-color: var(--stm-purple); 
            border-color: var(--stm-purple); 
            color: #ffffff;
            font-weight: 600;
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(90, 55, 123, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-save:hover, 
        .btn-stm-save:focus {
            background-color: #492a63; 
            border-color: #492a63;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        /* BOT√ìN ELIMINAR (Rojo - stm-red) */
        .btn-stm-delete {
            background-color: var(--stm-red); 
            border-color: var(--stm-red); 
            color: #ffffff; 
            border-radius: 8px; 
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .btn-stm-delete:hover, 
        .btn-stm-delete:focus {
            background-color: #b02a37;
            border-color: #b02a37;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        /* Estilo para unificar el contenedor del formulario/tabla */
        .table-responsive {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Encabezado de la tabla al estilo del dashboard */
        .table thead {
            background-color: var(--stm-indigo);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table th {
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        #loadingSpinner {
            text-align: center;
            padding: 40px;
        }
        
        /* Estilo para que las filas sean clickeables */
        .table-hover tbody tr {
            cursor: pointer;
        }
        .table-hover tbody tr:hover {
            background-color: #f0f4f9; /* Color m√°s suave al pasar el mouse */
        }

        /* Estilo espec√≠fico para los √≠conos de Activo/No Activo */
        .activo-icon {
            font-size: 1.2rem;
            display: block;
            text-align: center;
        }
        .text-success { color: #28a745 !important; } /* Bootstrap default green */
        .text-danger { color: #dc3545 !important; } /* Bootstrap default red */

        /* Columna Activo peque√±a */
        .table th.col-activo {
            width: 1%;
            text-align: center;
        }
        .table td.col-activo {
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="main-container">
            
            <div class="logo-container">
                <!-- Se asume que el logo_STM.png est√° disponible -->
                <img src="logo_STM.png" alt="Logo Sindicato de Trabajadores Municipales">
            </div>

            <h2 class="fs-4 fw-bold text-gray-800 border-bottom pb-2 mb-4">üì¢ Gestor de <span style="color: #4f46e5;">Novedades</span></h2>
            
            <div class="d-flex justify-content-end mb-4">
                <button type="button" class="btn btn-stm-create" onclick="openModal()">
                    <i class="fas fa-plus-circle me-2"></i> Crear Nueva Novedad
                </button>
            </div>
            
            <!-- CAMBIO CLAVE: Se elimina #ID y se agrega ACTIVO al inicio -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <!-- Columna 'Activo' con estilo para ser peque√±a -->
                            <th scope="col" class="col-activo">ACTIVO</th>
                            <th scope="col">T√≠tulo</th>
                            <th scope="col">Fecha</th>
                            <th scope="col">Contenido</th>
                        </tr>
                    </thead>
                    <tbody id="novedadesTableBody">
                    </tbody >
                </table>
                <div id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando novedades...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando novedades...</p>
                </div>
            </div>

        </div>
    </div>
    
    <!-- MODAL DE CREACI√ìN/EDICI√ìN -->
    <div class="modal fade" id="novedadModal" tabindex="-1" aria-labelledby="novedadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="novedadForm" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="novedadModalLabel">Crear Novedad</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <!-- El ID se sigue manteniendo como campo oculto -->
                        <input type="hidden" id="inputIdNovedad" name="ID">
                        
                        <div class="mb-3">
                            <label for="inputTitulo" class="form-label">
                                T√≠tulo: <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="inputTitulo" name="Titulo" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="inputFecha" class="form-label">
                                Fecha novedad: <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" id="inputFecha" name="Fecha" required>
                        </div>

                        <div class="mb-3">
                            <label for="textareaContenido" class="form-label">
                                Contenido: <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="textareaContenido" name="Contenido" rows="6" required></textarea>
                        </div>
                        
                        <!-- El checkbox Activo se mantiene en el modal, que es donde se edita -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="inputActivo" name="Activo" value="SI">
                            <label class="form-check-label" for="inputActivo">
                                ¬øNovedad Activa? (Marcar para mostrar)
                            </label>
                        </div>
                        
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <!-- Bot√≥n de Eliminar: Solo visible en modo edici√≥n -->
                        <button type="button" class="btn btn-stm-delete" id="btnEliminarEnModal" style="display: none;">
                            <i class="fas fa-trash-alt me-2"></i> Eliminar Novedad
                        </button>
                        
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelarModal">Cancelar</button>
                            <button type="submit" class="btn btn-stm-save" id="btnGuardar">Guardar Novedad</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMACI√ìN DE ELIMINACI√ìN (SIN CAMBIOS) -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">‚ö†Ô∏è Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro/a que quer√©s eliminar la novedad con ID: <strong id="deleteNovedadId" class="text-danger"></strong>?</p>
                    <p class="text-danger">¬°Esta acci√≥n no se puede deshacer!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-stm-delete" id="btnAceptarEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE FEEDBACK (SIN CAMBIOS) -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">Resultado de la Operaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="feedbackModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // L√ìGICA DE JAVASCRIPT MODIFICADA
        // URL de tu AppScript (Mantenida por si acaso)
        const APPSSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxfNlhTU4hO8linQddyhVvd5rTrsAQxx1XvlsJO5tbBvUeyzczi1q-LbwU6-dSsLPvt9w/exec'; 

        const novedadesTableBody = document.getElementById('novedadesTableBody');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        const novedadForm = document.getElementById('novedadForm');
        const novedadModal = new bootstrap.Modal(document.getElementById('novedadModal'));
        const novedadModalLabel = document.getElementById('novedadModalLabel');
        const btnGuardar = document.getElementById('btnGuardar');
        const btnCancelarModal = document.getElementById('btnCancelarModal'); 
        
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const btnAceptarEliminar = document.getElementById('btnAceptarEliminar');
        const btnEliminarEnModal = document.getElementById('btnEliminarEnModal'); 
        
        const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const feedbackModalBody = document.getElementById('feedbackModalBody');

        let novedadIdToDelete = null;

        let originalGuardarText = '';
        let originalEliminarText = '';


        document.addEventListener('DOMContentLoaded', () => {
            originalGuardarText = btnGuardar.textContent;
            originalEliminarText = btnAceptarEliminar.textContent;
            fetchNovedades();
        });


        novedadForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = document.getElementById('inputIdNovedad').value;
            const accion = id ? 'ACTUALIZAR' : 'CREAR';
            await manejarEnvio(accion, id);
        });

        // Evento para el nuevo bot√≥n "Eliminar Novedad" dentro del modal de edici√≥n
        btnEliminarEnModal.addEventListener('click', function() {
            const id = document.getElementById('inputIdNovedad').value;
            if (id) {
                // Cerramos el modal de edici√≥n y abrimos el de confirmaci√≥n
                novedadModal.hide(); 
                showDeleteConfirm(id);
            }
        });

        btnAceptarEliminar.addEventListener('click', async function() {
            if (novedadIdToDelete) {
                setLoadingState(true, 'ELIMINAR');
                confirmDeleteModal.hide();
                await manejarEnvio('ELIMINAR', novedadIdToDelete);
                novedadIdToDelete = null; 
            }
        });

        /**
         * Maneja el estado de carga de los botones principales del CRUD.
         * @param {boolean} isLoading - Si debe entrar en estado de carga (true) o salir (false).
         * @param {string} [accion] - Opcional. 'GUARDAR' o 'ELIMINAR'.
         */
        function setLoadingState(isLoading, accion) {
            const isGuardar = !accion || accion === 'GUARDAR';
            const isEliminar = accion === 'ELIMINAR';

            if (isGuardar) {
                btnGuardar.disabled = isLoading;
                btnCancelarModal.disabled = isLoading; 
                btnEliminarEnModal.disabled = isLoading; // Deshabilita tambi√©n el nuevo bot√≥n de eliminar

                if (isLoading) {
                    btnGuardar.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Aguarde...
                    `;
                    // A√±adimos la clase d-flex para que el spinner y texto queden centrados si hace falta
                    btnGuardar.classList.add('d-flex', 'align-items-center', 'justify-content-center'); 
                } else {
                    btnGuardar.textContent = originalGuardarText;
                    btnGuardar.classList.remove('d-flex', 'align-items-center', 'justify-content-center'); 
                }
            }

            if (isEliminar) {
                btnAceptarEliminar.disabled = isLoading;

                if (isLoading) {
                    btnAceptarEliminar.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Aguarde...
                    `;
                    btnAceptarEliminar.classList.add('d-flex', 'align-items-center', 'justify-content-center');
                } else {
                    btnAceptarEliminar.textContent = originalEliminarText;
                    btnAceptarEliminar.classList.remove('d-flex', 'align-items-center', 'justify-content-center');
                }
            }
        }


        function renderTable(novedades) {
            novedadesTableBody.innerHTML = '';
            loadingSpinner.style.display = 'none';
            // COLSPAN AJUSTADO A 3 (Activo, T√≠tulo, Fecha, Contenido)
            // Se asume que Contenido tiene un colspan mayor impl√≠cito, pero el n√∫mero de columnas visibles es 4.
            const COLSPAN_COUNT = 4; 

            if (novedades.length === 0) {
                novedadesTableBody.innerHTML = `
                    <tr>
                        <td colspan="${COLSPAN_COUNT}" class="text-center py-4 text-muted"> 
                            A√∫n no hay novedades cargadas. ¬°Cre√° la primera!
                        </td>
                    </tr>
                `;
                return;
            }

            novedades.forEach(novedad => {
                const isActive = (novedad.Activo || '').toUpperCase().trim() === 'SI'; 
                
                // Nuevo: √çcono de Activo
                const activoIcono = isActive 
                    ? '<i class="activo-icon fas fa-check-circle text-success" title="Activo"></i>' 
                    : '<i class="activo-icon fas fa-times-circle text-danger" title="No Activo"></i>';
                
                const row = novedadesTableBody.insertRow();
                // Se agrega el evento onclick a la fila completa, pasando todos los datos
                row.setAttribute('onclick', `openModal(
                    '${novedad.ID}', 
                    '${novedad.Titulo.replace(/'/g, "\\'")}', 
                    '${novedad.Fecha}', 
                    \`${novedad.Contenido.replace(/`/g, '\\`')}\`,
                    '${novedad.Activo}' 
                )`);

                row.innerHTML = `
                    <!-- Columna Activo con el √≠cono -->
                    <td class="col-activo">${activoIcono}</td>
                    <!-- T√≠tulo -->
                    <td>${novedad.Titulo}</td>
                    <!-- Fecha -->
                    <td>${novedad.Fecha}</td>
                    <!-- Contenido (recortado) -->
                    <td>${novedad.Contenido.substring(0, 50).trim()}${novedad.Contenido.length > 50 ? '...' : ''}</td>
                `;
            });
        }

        function openModal(id = '', titulo = '', fecha = '', contenido = '', activo = 'SI') {
            novedadForm.reset(); 
            const inputIdNovedad = document.getElementById('inputIdNovedad');
            const inputTitulo = document.getElementById('inputTitulo');
            const inputFecha = document.getElementById('inputFecha'); 
            const textareaContenido = document.getElementById('textareaContenido');
            const inputActivo = document.getElementById('inputActivo');
            
            inputIdNovedad.value = id;

            if (id) {
                // Modo Edici√≥n
                novedadModalLabel.textContent = 'Editar Novedad (ID: ' + id + ')';
                originalGuardarText = 'Guardar Cambios';
                
                inputTitulo.value = titulo;
                inputFecha.value = fecha;
                textareaContenido.value = contenido;
                // El estado 'activo' se sigue cargando en el checkbox del modal
                inputActivo.checked = (activo || '').toUpperCase().trim() === 'SI'; 
                
                // Muestra el bot√≥n de eliminar
                btnEliminarEnModal.style.display = 'block'; 
                
            } else {
                // Modo Creaci√≥n: Establecer valores por defecto
                novedadModalLabel.textContent = 'Crear Nueva Novedad';
                originalGuardarText = 'Guardar Novedad';
                inputActivo.checked = true; 

                // Oculta el bot√≥n de eliminar
                btnEliminarEnModal.style.display = 'none'; 

                // Poner la fecha actual por defecto
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0'); 
                const dd = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${yyyy}-${mm}-${dd}`;
                inputFecha.value = formattedDate; 
            }
            
            setLoadingState(false, 'GUARDAR');

            novedadModal.show();
        }

        function showDeleteConfirm(id) {
            novedadIdToDelete = id;
            document.getElementById('deleteNovedadId').textContent = id;
            setLoadingState(false, 'ELIMINAR');
            confirmDeleteModal.show();
        }

        function showFeedback(message, success = true) {
            const title = success ? '‚úÖ ¬°Operaci√≥n Exitosa!' : '‚ùå ¬°Error!';
            const header = document.getElementById('feedbackModal').querySelector('.modal-header');
            const titleEl = document.getElementById('feedbackModalLabel');
            
            titleEl.textContent = title;
            feedbackModalBody.innerHTML = `<p>${message}</p>`;

            // Cambiar el color del header del modal de feedback
            header.classList.remove('bg-danger', 'bg-success', 'text-white');
            if (success) {
                header.classList.add('bg-success', 'text-white'); 
            } else {
                header.classList.add('bg-danger', 'text-white'); 
            }
            // Asegurarse de que el bot√≥n de cerrar sea blanco si el fondo es oscuro
            document.getElementById('feedbackModal').querySelector('.btn-close').classList.add('btn-close-white');


            feedbackModal.show();
        }


        async function fetchNovedades() {
            loadingSpinner.style.display = 'block';
            novedadesTableBody.innerHTML = ''; 

            try {
                const response = await fetch(APPSSCRIPT_URL + '?action=READ_ALL');
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && Array.isArray(data.novedades)) {
                        renderTable(data.novedades);
                    } else {
                        throw new Error(data.message || 'Error en el formato de datos devueltos.');
                    }
                } else {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                loadingSpinner.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        Error al cargar las novedades: ${error.message}
                        <br>Revis√° la configuraci√≥n de tu AppScript.
                    </div>
                `;
                console.error('Error al cargar novedades:', error);
            }
        }

        async function manejarEnvio(accion, id) {
            let method, body, apiUrl, successMessage;

            setLoadingState(true, accion === 'ELIMINAR' ? 'ELIMINAR' : 'GUARDAR');
            
            const formData = new FormData(novedadForm); 
            
            const inputActivo = document.getElementById('inputActivo');
            if (!inputActivo.checked) {
                formData.set('Activo', 'NO'); 
            } else {
                 formData.set('Activo', 'SI');
            }

            switch (accion) {
                case 'CREAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    formData.append('action', 'CREATE');
                    body = formData;
                    successMessage = 'La novedad se cre√≥ exitosamente.';
                    break;
                case 'ACTUALIZAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    formData.append('action', 'UPDATE');
                    formData.append('ID', id);
                    body = formData;
                    successMessage = `La novedad ${id} se actualiz√≥ correctamente.`;
                    break;
                case 'ELIMINAR':
                    method = 'POST';
                    apiUrl = APPSSCRIPT_URL;
                    const deleteData = new FormData();
                    deleteData.append('action', 'DELETE');
                    deleteData.append('ID', id);
                    body = deleteData;
                    successMessage = `La novedad ${id} fue eliminada.`;
                    break;
                default:
                    showFeedback('Acci√≥n desconocida.', false);
                    return;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: method,
                    body: body 
                });

                const responseText = await response.text();
                let result = {};
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    if (responseText.includes('Error')) {
                        throw new Error('Error desconocido del servidor de AppScript.');
                    }
                    result = { status: 'success' };
                }

                if (response.ok && result.status === 'success') {
                    novedadModal.hide();
                    showFeedback(successMessage, true);
                    await fetchNovedades();
                } else {
                    const errorDetail = result.message || 'Error en la operaci√≥n en la planilla.';
                    throw new Error(errorDetail);
                }

            } catch (error) {
                if (accion !== 'ELIMINAR') {
                    novedadModal.hide();
                }
                showFeedback(`¬°Error al ejecutar la operaci√≥n! Detalle: ${error.message}`, false);
                console.error(`Error de ${accion}:`, error);
            } finally {
                setLoadingState(false, accion === 'ELIMINAR' ? 'ELIMINAR' : 'GUARDAR');
            }
        }

    </script>
</body>
</html>