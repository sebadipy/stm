<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Mando - STM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f7;
        }
        #novedades-view, #data-table-view {
            display: none;
        }
        .btn-custom {
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .btn-custom.active {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5;
            box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.4);
            transform: translateY(-2px);
        }
        .btn-custom:not(.active) {
            background-color: #ffffff;
            color: #4f46e5;
            border-color: #c7d2fe;
        }
        .btn-custom:not(.active):hover {
            background-color: #f5f6fa;
            border-color: #a5b4fc;
        }
        .btn-icon {
            @apply p-1 rounded-full transition-colors duration-150;
        }
        #table-container th {
            white-space: nowrap;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <div class="max-w-7xl mx-auto">
        
        <header class="mb-6 flex items-center justify-between border-b-4 border-indigo-500 pb-2">
            <div class="flex items-center">
                <img src="https://placehold.co/100x100/4f46e5/ffffff?text=STM+Logo" alt="Logo STM" class="h-16 w-16 mr-4 rounded-full shadow-lg object-cover">
                <div>
                    <h1 class="text-4xl font-extrabold text-gray-800">
                        Tablero de Mando <span class="text-indigo-600">STM</span>
                    </h1>
                    <p class="text-gray-600 mt-1 text-lg">Consulta rápida de datos clave y gestión de novedades.</p>
                </div>
            </div>
            <div id="user-info" class="text-right text-sm text-gray-500 hidden sm:block">
                Conexión: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded text-green-600">Apps Script Activo</span>
            </div>
        </header>

        <div id="btn-group" class="flex flex-wrap justify-center gap-4 mb-6 p-4 bg-white rounded-xl shadow-xl">
            <button 
                data-view="data-table"
                data-sheet="tabla_consulta"
                class="btn-custom py-3 px-8 text-lg font-semibold rounded-full shadow-lg active"
            >
                Tabla Consulta
            </button>
            <button 
                data-view="data-table"
                data-sheet="afiliacion"
                class="btn-custom py-3 px-8 text-lg font-semibold rounded-full shadow-lg"
            >
                Afiliación
            </button>
            <button 
                data-view="novedades"
                data-sheet="novedades"
                class="btn-custom py-3 px-8 text-lg font-semibold rounded-full shadow-lg"
            >
                Novedades (Gestión)
            </button>
        </div>
        
        <div id="data-table-view" class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Datos de la Hoja de Cálculo: <span id="current-sheet-title" class="text-indigo-600">Tabla Consulta</span></h2>
            <p id="data-loading-message" class="text-center text-indigo-600 font-medium py-8">Cargando datos desde Google Sheets...</p>
            <div id="table-container" class="overflow-x-auto">
            </div>
        </div>

        <div id="novedades-view" class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Gestión de Novedades (CRUD)</h2>
            
            <form id="novedad-form" class="space-y-4 mb-6 p-4 border rounded-lg bg-gray-50">
                <input type="hidden" id="novedad-id">

                <div class="flex flex-col">
                    <label for="titulo" class="font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" id="titulo" required class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="descripcion" class="font-medium text-gray-700 mb-1">Descripción</label>
                        <textarea id="descripcion" required class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-24"></textarea>
                    </div>
                    
                    <div class="flex flex-col">
                        <label for="fecha_novedad" class="font-medium text-gray-700 mb-1">Fecha de Novedad</label>
                        <input type="date" id="fecha_novedad" required class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        
                        <div class="mt-4 flex items-center space-x-2">
                            <input type="checkbox" id="activo" class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                            <label for="activo" class="text-gray-700">Activo (SI/NO)</label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelar-btn" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors duration-150" style="display:none;">
                        Cancelar Edición
                    </button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors duration-150 shadow-md">
                        Guardar Novedad
                    </button>
                </div>
            </form>

            <div class="mb-4">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Registros Existentes (Desde Google Sheet)</h3>
                <p id="loading-message" class="text-center text-indigo-600 font-medium">Cargando novedades desde Google Sheet...</p>
                <div class="overflow-x-auto rounded-lg shadow-lg">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-indigo-600 text-white">
                            <tr>
                                <th class="py-3 px-4 text-left">ID</th>
                                <th class="py-3 px-4 text-left">Título</th>
                                <th class="py-3 px-4 text-left hidden sm:table-cell">Descripción</th>
                                <th class="py-3 px-4 text-left hidden md:table-cell">Fecha</th>
                                <th class="py-3 px-4 text-center">Activo</th>
                                <th class="py-3 px-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="novedades-list" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        
        // ¡IMPORTANTE! REEMPLAZÁ ESTO CON TU URL REAL DE APPS SCRIPT
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxs8yMVy2yuIlRfpOYXLlN8GbEGf7xJaK1PCFOwTraLvV6NpITNP8vUa-59lTeF2pSs3w/exec'; 
        
        const SHEET_ID = '1OZnWCvh9NpBaoZndAV1IPPqtNWgQnv8GMh6J2-l3wZo'; 
        const sheetGids = {
            'tabla_consulta': '0',
            'afiliacion': '1038720919', 
            'novedades': '195669740'
        };

        const dataTableView = document.getElementById('data-table-view');
        const novedadesView = document.getElementById('novedades-view');
        const buttons = document.querySelectorAll('#btn-group button');
        const tableContainer = document.getElementById('table-container');
        const dataLoadingMessage = document.getElementById('data-loading-message');
        const currentSheetTitle = document.getElementById('current-sheet-title');

        const form = document.getElementById('novedad-form');
        const novedadesList = document.getElementById('novedades-list');
        const loadingMessage = document.getElementById('loading-message');
        const inputId = document.getElementById('novedad-id');
        const inputTitulo = document.getElementById('titulo');
        const inputDescripcion = document.getElementById('descripcion');
        const inputFecha = document.getElementById('fecha_novedad');
        const inputActivo = document.getElementById('activo');
        const cancelarBtn = document.getElementById('cancelar-btn');

        let currentEditingId = null;
        let novedadesData = {};

        // --- Funciones de GVIZ para Tablas de Consulta ---
        
        function createGvizUrl(gid) {
            return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
        }

        function parseGvizData(jsonText) {
            try {
                const jsonString = jsonText.substring(jsonText.indexOf('(') + 1, jsonText.lastIndexOf(')'));
                const json = JSON.parse(jsonString);
                const table = json.table;
                
                if (!table || !table.rows || table.rows.length === 0) {
                    return { headers: [], data: [] };
                }
                
                const headers = table.cols.map(col => col.label || col.id);
                
                const data = table.rows.map(row => {
                    return headers.map((header, index) => {
                        const cell = row.c[index];
                        return cell ? (cell.f || cell.v || '') : '';
                    });
                });
                
                return { headers, data };
            } catch (e) {
                console.error("Error al parsear el JSON de Google Sheets (GViz):", e);
                return { headers: [], data: [] };
            }
        }

        function renderDataTable(headers, data) {
            if (data.length === 0) {
                tableContainer.innerHTML = '<p class="text-center py-8 text-gray-500">No hay datos disponibles en esta hoja.</p>';
                return;
            }

            let html = `
                <div class="rounded-xl overflow-hidden shadow-2xl">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                        <thead class="bg-indigo-600 text-white sticky top-0">
                            <tr>
                                ${headers.map(header => `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            data.forEach((row, index) => {
                const rowClass = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                html += `<tr class="${rowClass}">`;
                html += row.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cell}</td>`).join('');
                html += `</tr>`;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            tableContainer.innerHTML = html;
        }

        async function loadSheetData(sheetName) {
            const gid = sheetGids[sheetName];
            if (!gid) {
                dataLoadingMessage.textContent = `Error: GID no encontrado para la hoja '${sheetName}'.`;
                return;
            }
            
            currentSheetTitle.textContent = sheetName.charAt(0).toUpperCase() + sheetName.slice(1).replace('_', ' '); 
            dataLoadingMessage.style.display = 'block';
            tableContainer.innerHTML = '';
            
            try {
                const response = await fetch(createGvizUrl(gid));
                const text = await response.text();
                const { headers, data } = parseGvizData(text);
                
                renderDataTable(headers, data);
                
            } catch (error) {
                dataLoadingMessage.textContent = `Error al cargar los datos.`;
            } finally {
                dataLoadingMessage.style.display = 'none';
            }
        }

        // --- Funciones CRUD para Novedades (Apps Script) ---
        
        async function loadNovedadesFromAppsScript() {
            // *** CORRECCIÓN: Se eliminó la validación estricta de la URL que causaba el error 'La URL de Apps Script no está configurada.' ***
            // La URL definida en la constante APPS_SCRIPT_URL se usará directamente.
            
            loadingMessage.style.display = 'block';
            novedadesList.innerHTML = '';
            
            try {
                const response = await fetch(APPS_SCRIPT_URL); // GET para leer
                const result = await response.json();
                
                if (result.error) throw new Error(result.error);

                novedadesData = {};
                // Guardamos en el objeto local usando el ID como clave
                result.novedades.forEach(nov => {
                    novedadesData[nov.id] = nov; 
                });
                
                renderNovedades(result.novedades);
                
            } catch (error) {
                console.error("Error al cargar novedades:", error);
                loadingMessage.textContent = `ERROR de Conexión o Datos: ${error.message}. Asegurate de que tu Apps Script esté publicado correctamente.`;
            } finally {
                loadingMessage.style.display = 'none';
            }
        }
        
        function renderNovedades(novedades) {
            novedadesList.innerHTML = ''; 

            if (!novedades || novedades.length === 0) {
                novedadesList.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay novedades registradas.</td></tr>`;
                return;
            }

            // Ordenar por ID descendente
            novedades.sort((a, b) => parseInt(b.id) - parseInt(a.id));

            novedades.forEach((novedad) => {
                const row = novedadesList.insertRow();
                const activoText = String(novedad.activo || 'NO').toUpperCase();
                const descripcionText = String(novedad.descripcion || '');
                const descripcionDisplay = descripcionText.substring(0, 50) + (descripcionText.length > 50 ? '...' : '');

                row.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-gray-900">${novedad.id}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">${novedad.titulo}</td>
                    <td class="py-3 px-4 text-sm text-gray-500 truncate max-w-xs hidden sm:table-cell">${descripcionDisplay}</td>
                    <td class="py-3 px-4 text-sm text-gray-500 hidden md:table-cell">${novedad.fecha_novedad}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium ${activoText === 'SI' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${activoText}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center space-x-2">
                        <button class="btn-icon text-indigo-600 hover:bg-indigo-100" data-id="${novedad.id}" onclick="editNovedad('${novedad.id}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.646 12.646l-4.5-4.5.793-.793 4.5 4.5-.793.793zM8 12.5a2.5 2.5 0 10-5 0 2.5 2.5 0 005 0z" /><path fill-rule="evenodd" d="M12.121 14.121L15 11.242V17a1 1 0 01-1 1H4a1 1 0 01-1-1v-4.758l2.879-2.879 5.857 5.857z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="btn-icon text-red-600 hover:bg-red-100" data-id="${novedad.id}" onclick="deleteNovedad('${novedad.id}')" title="Borrar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                novedadesList.appendChild(row);
            });
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                id: inputId.value, // Envía el ID si es edición
                titulo: inputTitulo.value,
                descripcion: inputDescripcion.value,
                fecha_novedad: inputFecha.value, 
                ACTIVO: inputActivo.checked ? 'SI' : 'NO'
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Guardando...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data), 
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();

                if (result.error) throw new Error(result.error);

                alert("Operación exitosa: " + result.message);
                
                resetForm(); // Limpia el formulario
                loadNovedadesFromAppsScript(); // Recarga la tabla

            } catch (error) {
                alert(`ERROR al guardar. Mensaje: ${error.message}`);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        window.editNovedad = (id) => {
            const novedad = novedadesData[id];

            if (novedad) {
                inputId.value = id;
                inputTitulo.value = novedad.titulo;
                inputDescripcion.value = novedad.descripcion;
                inputFecha.value = novedad.fecha_novedad; 
                
                inputActivo.checked = String(novedad.activo).toUpperCase() === 'SI';
                
                currentEditingId = id;
                cancelarBtn.style.display = 'inline-block';
                form.querySelector('button[type="submit"]').textContent = 'Actualizar Novedad (ID: ' + id + ')';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        
        window.deleteNovedad = async (id) => {
            if (!confirm(`¿Estás seguro de que deseas borrar la novedad #${id}? Esta acción es permanente.`)) return;
            
            const data = { action: 'delete', id: id };
            
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = `Borrando registro #${id}...`;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();

                if (result.error) throw new Error(result.error);

                alert("Borrado exitoso: " + result.message);
                loadNovedadesFromAppsScript();

            } catch (error) {
                alert(`Error al borrar: ${error.message}`);
            }
        };

        function resetForm() {
            form.reset();
            inputId.value = '';
            currentEditingId = null;
            cancelarBtn.style.display = 'none';
            form.querySelector('button[type="submit"]').textContent = 'Guardar Novedad';
            inputActivo.checked = false; 
        }

        cancelarBtn.addEventListener('click', (e) => {
            e.preventDefault();
            resetForm();
        });


        
        function loadView(sheetName, viewType) {
            if (viewType === 'data-table') {
                dataTableView.style.display = 'block';
                novedadesView.style.display = 'none';
                loadSheetData(sheetName);
                
            } else if (viewType === 'novedades') {
                dataTableView.style.display = 'none';
                novedadesView.style.display = 'block';
                loadNovedadesFromAppsScript();
            }

            buttons.forEach(btn => {
                if (btn.getAttribute('data-sheet') === sheetName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                loadView(button.getAttribute('data-sheet'), button.getAttribute('data-view'));
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
             loadView('tabla_consulta', 'data-table');
        });

    </script>
</body>
</html>