<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Mando - STM (Consulta)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos generales limpios */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f7;
        }
        /* Estilos del Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 90%;
            /* Aumentamos el ancho m谩ximo para el modal de afiliaci贸n con m谩s campos */
            max-width: 700px; 
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Estilos de los botones de navegaci贸n */
        .btn-custom {
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        /* ESTILOS ACTIVOS (Azul ndigo por defecto para las vistas de tabla) */
        .btn-custom.active-indigo {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5;
            box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.4);
            transform: translateY(-2px);
        }
        .btn-custom:not(.active-indigo) {
            background-color: #ffffff;
            color: #4f46e5;
            border-color: #c7d2fe;
        }
        .btn-custom:not(.active-indigo):hover {
            background-color: #f5f6fa;
            border-color: #a5b4fc;
        }
        
        /* Ajuste para las cabeceras de la tabla */
        #table-container th {
            white-space: nowrap;
        }

        /* NUEVOS ESTILOS PARA EL LOGO */
        .logo-container {
            width: 4rem; 
            height: 4rem; 
            overflow: hidden;
            border-radius: 9999px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
        }
        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <div class="max-w-7xl mx-auto">
        
        <header class="mb-6 flex items-center justify-between border-b-4 border-indigo-500 pb-2">
            <div class="flex items-center">
                <div class="logo-container mr-4">
                    <img src="logo_STM.png" alt="Logo Sindicato de Trabajadores Municipales" onerror="this.onerror=null; this.src='https://placehold.co/100x100/4f46e5/ffffff?text=STM'">
                </div>
                <div>
                    <h1 class="text-4xl font-extrabold text-gray-800">
                        Tablero de Mando <span class="text-indigo-600">STM</span>
                    </h1>
                    
                </div>
            </div>

            <button 
                onclick="logout()"
                class="bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md"
            >
                Cerrar Sesi贸n
            </button>
            </header>

        <div id="btn-group" class="flex flex-wrap justify-center gap-4 mb-6 p-4 bg-white rounded-xl shadow-xl">
            <button 
                data-sheet="tabla_consulta"
                class="btn-custom py-3 px-8 text-lg font-semibold rounded-full shadow-lg active-indigo"
            >
                Consultas
            </button>
            <button 
                data-sheet="afiliacion"
                class="btn-custom py-3 px-8 text-lg font-semibold rounded-full shadow-lg"
            >
                Afiliaciones
            </button>
            <button 
                data-sheet="gestor_novedades_external"
                class="btn-custom py-3 px-8 text-lg font-semibold rounded-full shadow-lg"
            >
                Gestor Novedades
            </button>
            <button 
                data-sheet="credencial_qr"
                class="btn-custom py-3 px-8 text-lg font-semibold rounded-full shadow-lg"
            >
                Generar Credencial
            </button>
        </div>
        
        <div id="data-table-view" class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2"> <span id="current-sheet-title" class="text-indigo-600">Tabla Consulta</span></h2>
            <p id="data-loading-message" class="text-center text-indigo-600 font-medium py-8">Cargando datos desde base de datos...</p>
            <div id="table-container" class="overflow-x-auto">
                </div>
        </div>
    </div>

    <div id="data-modal-overlay" class="modal-overlay">
        <div class="modal-content w-full md:w-1/2 lg:w-1/3">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-indigo-700">Detalles de la Fila</h3> 
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="modal-details" class="space-y-4">
                </div>

            <div class="mt-6 pt-4 border-t flex justify-end">
                <button onclick="closeModal()" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    <script>
        
        // ---  CDIGO DE VERIFICACIN DE SEGURIDAD  ---
        // Chequea si la bandera de autenticaci贸n existe en el localStorage
        if (localStorage.getItem('isAuthenticatedSTM') !== 'true') {
            // Si no est谩 autenticado, redirigir al login
            window.location.href = 'index.html';
        }
        // --- FIN CDIGO DE VERIFICACIN ---
        
        // 隆IMPORTANTE! REEMPLAZ ESTO CON TU URL REAL DE APPS SCRIPT
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxfNlhTU4hO8linQddyhVvd5rTrsAQxx1XvlsJO5tbBvUeyzczi1q-LbwU6-dSsLPvt9w/exec'; 
        
        const SHEET_ID = '1OZnWCvh9NpBaoZndAV1IPPqtNWgQnv8GMh6J2-l3wZo'; 
        const sheetGids = {
            'tabla_consulta': '0',
            'afiliacion': '1038720919',
            'gestor_novedades_external': null,
            // No se necesita GID para credencial_qr ya que es una redirecci贸n.
        };

        // Elementos de UI
        const dataTableView = document.getElementById('data-table-view');
        const buttons = document.querySelectorAll('#btn-group button'); 
        const tableContainer = document.getElementById('table-container');
        const dataLoadingMessage = document.getElementById('data-loading-message');
        const currentSheetTitle = document.getElementById('current-sheet-title');
        const dataModalOverlay = document.getElementById('data-modal-overlay');
        const modalTitle = document.getElementById('modal-title'); 
        const modalDetails = document.getElementById('modal-details'); 

        // Almacena los encabezados completos para usar en el modal de Afiliaci贸n
        let currentFullHeaders = [];
        
        let lastActiveSheet = 'tabla_consulta'; // Para recordar qu茅 vista estaba activa

        // --- FUNCIONES DEL MODAL ---

        /**
         * Muestra el modal con el contenido apropiado (texto de consulta o detalles de afiliaci贸n).
         * @param {HTMLElement} rowElement La fila (tr) que fue clickeada.
         */
        window.showModal = function(rowElement) {
            
            // Solo abrimos el modal si estamos en las vistas 'tabla_consulta' o 'afiliacion'
            if (lastActiveSheet !== 'tabla_consulta' && lastActiveSheet !== 'afiliacion') {
                return; 
            }

            modalDetails.innerHTML = ''; // Limpiar contenido previo

            if (lastActiveSheet === 'tabla_consulta') {
                // --- LGICA PARA TABLA CONSULTA (Texto 煤nico) ---
                const encodedConsulta = rowElement.getAttribute('data-consulta');
                
                if (encodedConsulta) {
                    const consultaValue = decodeURIComponent(encodedConsulta);

                    modalTitle.textContent = 'Consulta Completa';
                    // Renderiza el contenido como un bloque de texto
                    modalDetails.innerHTML = `
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs font-semibold uppercase text-gray-500 mb-2">CONSULTA:</p>
                            <p class="text-base whitespace-pre-wrap text-gray-800">${consultaValue}</p>
                        </div>
                    `;
                    
                    dataModalOverlay.style.display = 'flex';
                } else {
                    console.error("Error: No se encontr贸 el atributo 'data-consulta' en la fila. El modal no puede cargar el contenido.");
                }

            } else if (lastActiveSheet === 'afiliacion') {
                // --- LGICA PARA AFILIACIN (Datos estructurados - Ahora incluye TODOS los campos de B a Q) ---
                const encodedFullData = rowElement.getAttribute('data-full-data');

                if (encodedFullData) {
                    try {
                        const jsonString = decodeURIComponent(encodedFullData);
                        const fullData = JSON.parse(jsonString);

                        // Usamos el campo 'NOMBRE Y APELLIDO' como t铆tulo del modal
                        const affiliationName = fullData['Nombre y Apellido'] || 'Afiliado/a';
                        modalTitle.textContent = `Detalles de Afiliaci贸n: ${affiliationName}`;

                        let detailsHtml = '';
                        
                        // Lista de los campos que queremos mostrar y c贸mo llamarlos
                        const fieldsToShow = [
                            { key: 'Nombre y Apellido', label: 'NOMBRE Y APELLIDO' },
                            { key: 'DNI', label: 'DNI' },
                            { key: 'Legajo', label: 'LEGAJO' },
                            { key: 'CUIL', label: 'CUIL' },
                            { key: 'Tel茅fono Celular', label: 'TELFONO CELULAR' },
                            { key: 'Tel茅fono Alternativo', label: 'TELFONO ALTERNATIVO' },
                            { key: 'Email', label: 'EMAIL' },
                            { key: 'Direcci贸n', label: 'DIRECCIN' },
                            { key: 'Localidad', label: 'LOCALIDAD' },
                            { key: 'Provincia', label: 'PROVINCIA' },
                            { key: 'Dependencia', label: 'DEPENDENCIA' },
                            { key: 'rea', label: 'REA/SECTOR' },
                            { key: 'Puesto', label: 'PUESTO' },
                            { key: 'Fecha de Ingreso', label: 'FECHA DE INGRESO' },
                            { key: 'Antig眉edad', label: 'ANTIGEDAD' },
                            { key: 'Fecha de Solicitud', label: 'FECHA DE SOLICITUD' },
                            // Quitamos TIMESTAMP si existiera, ya que no es relevante para el usuario final
                        ];


                        // Usamos una lista de descripci贸n (key-value) para mostrar los datos
                        detailsHtml += '<dl class="divide-y divide-gray-200">';
                        
                        // Recorrer la lista definida
                        fieldsToShow.forEach(field => {
                            const value = fullData[field.key] || 'N/A'; // Usar 'N/A' si el valor es nulo o indefinido
                            const displayLabel = field.label;

                            // Mostrar solo si el campo no est谩 completamente vac铆o (solo espacios o N/A)
                            if (value.trim() && value.toUpperCase() !== 'N/A') { 
                                detailsHtml += `
                                    <div class="py-3 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 hover:bg-indigo-50 transition duration-100 rounded-lg">
                                        <dt class="text-sm font-medium text-gray-500">${displayLabel}</dt>
                                        <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0 whitespace-pre-wrap">${value}</dd>
                                    </div>
                                `;
                            }
                        });
                        
                        detailsHtml += '</dl>';

                        // Si no hay detalles para mostrar, indicarlo.
                        if (detailsHtml === '<dl class="divide-y divide-gray-200"></dl>') {
                            modalDetails.innerHTML = `<p class="text-center py-4 text-gray-500">No se encontraron detalles adicionales para este registro.</p>`;
                        } else {
                            modalDetails.innerHTML = detailsHtml;
                        }
                        
                        dataModalOverlay.style.display = 'flex';

                    } catch (e) {
                        console.error("Error al parsear datos de afiliaci贸n:", e);
                    }
                } else {
                    console.error("Error: No se encontr贸 el atributo 'data-full-data' en la fila. El modal no puede cargar el contenido.");
                }
            }
        }

        /**
         * Cierra el modal.
         */
        window.closeModal = function() {
            dataModalOverlay.style.display = 'none';
        }

        // Permitir cerrar el modal haciendo click fuera de su contenido
        dataModalOverlay.addEventListener('click', (e) => {
            if (e.target === dataModalOverlay) {
                closeModal();
            }
        });

        // --- FUNCIONES ESPECFICAS ---

        /**
         *  CAMBIO AQU: Ahora redirige en la misma ventana 
         */
        function openGestorNovedades() {
            // Utilizamos window.location.href para abrir en la misma pesta帽a
            window.location.href = 'gestor_novedades.html';
        }

        /**
         * Funci贸n para cerrar la sesi贸n (eliminar la bandera) y redirigir al login.
         */
        window.logout = function() {
            localStorage.removeItem('isAuthenticatedSTM');
            window.location.href = 'index.html';
        }

        // --- FUNCIONES GVIZ (Tablas de Consulta) ---

        /**
         * Crea la URL de Google Visualization con orden descendente por fecha (columna A).
         * @param {string} gid El GID (identificador de hoja) de la hoja de c谩lculo.
         * @param {string} sheetName El nombre de la hoja (clave del objeto sheetGids).
         * @returns {string} La URL de consulta GViz.
         */
        function createGvizUrl(gid, sheetName) {
            let baseUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
            
            let selectQuery = '';

            if (sheetName === 'afiliacion') {
                // Afiliaci贸n: Seleccionamos A (Timestamp) y de B a Q (Todos los campos de datos de la tabla)
                // Se agrega 'order by A desc' para ordenar del m谩s nuevo al m谩s viejo
                selectQuery = 'select A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q order by A desc'; 
            } else if (sheetName === 'tabla_consulta') {
                // Para la tabla consulta, seleccionamos B, C, D, E (visibles) y F (CONSULTA - para el modal).
                // Se agrega 'order by A desc' para ordenar del m谩s nuevo al m谩s viejo (Columna A es el Timestamp)
                selectQuery = 'select A, B, C, D, E, F order by A desc'; 
            }
            
            // Si la consulta es para tabla_consulta, debemos seleccionar A tambi茅n para el sort, aunque no se use en el modal/vista
            if (sheetName === 'tabla_consulta') {
                 // La columna A (Timestamp) DEBE estar en la consulta SELECT si se usa en ORDER BY
                selectQuery = 'select A, B, C, D, E, F order by A desc'; 
            }


            if (selectQuery) {
                baseUrl += `&tq=${encodeURIComponent(selectQuery)}`;
            }
            
            return baseUrl;
        }

        /**
         * Parsea los datos JSON de Google Visualization.
         */
        function parseGvizData(jsonText, sheetName) {
            try {
                const jsonString = jsonText.substring(jsonText.indexOf('(') + 1, jsonText.lastIndexOf(')'));
                const json = JSON.parse(jsonString);
                const table = json.table;
                
                if (!table || !table.rows || table.rows.length === 0) {
                    return { headers: [], data: [], originalData: [], fullHeaders: [] };
                }
                
                // Mapeo de nombres de columna para las vistas (usando la estructura de la imagen)
                let headersMap = {}; 
                let visibleColumnsIndices = []; 
                
                if (sheetName === 'afiliacion') {
                    // Mapeo para Afiliaci贸n (Columnas A-Q)
                    headersMap = {
                        'A': 'TIMESTAMP', 
                        'B': 'Nombre y Apellido', // Visible
                        'C': 'DNI', 
                        'D': 'Legajo', // Visible
                        'E': 'CUIL', // Usamos CUIL aunque en la tabla dec铆a CUIL/DNI
                        'F': 'Tel茅fono Celular', 
                        'G': 'Tel茅fono Alternativo',
                        'H': 'Email', // Visible
                        'I': 'Direcci贸n',
                        'J': 'Localidad',
                        'K': 'Provincia',
                        'L': 'Dependencia',
                        'M': 'rea',
                        'N': 'Puesto',
                        'O': 'Fecha de Ingreso',
                        'P': 'Antig眉edad',
                        'Q': 'Fecha de Solicitud',
                    };
                    // ndices de las columnas VISIBLES (B, D, E, H) en el array de A-Q.
                    // B=1, D=3, E=4, H=7
                    visibleColumnsIndices = [1, 3, 4, 7]; 

                } else if (sheetName === 'tabla_consulta') {
                    // Mapeo para Tabla Consulta. (A, B, C, D, E, F)
                    headersMap = {
                        'A': 'TIMESTAMP', 
                        'B': 'APELLIDO', 
                        'C': 'NOMBRE', 
                        'D': 'TEL/CELULAR DE CONTACTO', 
                        'E': 'EMAIL', 
                        'F': 'CONSULTA', 
                    };
                    // B=1, C=2, D=3, E=4
                    visibleColumnsIndices = [1, 2, 3, 4]; // Solo las primeras 4 son visibles (B, C, D, E)
                }

                // Generar encabezados usando el mapeo (usa TODAS las columnas pedidas)
                let fullHeaders = table.cols.map(col => {
                    return headersMap[col.id] || col.label || col.id;
                });

                // Generar data original (todas las columnas pedidas: A-Q para afiliaci贸n, A-F para consulta)
                const originalData = table.rows.map(row => {
                    return row.c.map(cell => {
                        return cell ? (cell.f || (cell.v !== undefined ? cell.v : '')) : '';
                    });
                });
                
                // --- Aplicar el filtro de visibilidad ---
                let headers;
                let finalData;

                if (sheetName === 'afiliacion') {
                    // 1. Encabezados visibles (B, D, E, H)
                    headers = visibleColumnsIndices.map(index => fullHeaders[index]);

                    // 2. Datos visibles
                    finalData = originalData.map(row => {
                        return visibleColumnsIndices.map(index => row[index]);
                    });
                    
                    // Eliminamos el TIMESTAMP del fullHeaders para el modal, ya que no es un dato de afiliaci贸n
                    const timestampIndex = fullHeaders.findIndex(h => h === 'TIMESTAMP');
                    if (timestampIndex !== -1) {
                        fullHeaders.splice(timestampIndex, 1);
                    }

                } else if (sheetName === 'tabla_consulta') {
                    // L贸gica para tabla_consulta (ocultar la columna 'TIMESTAMP' (A) y 'CONSULTA' (F))
                    
                    // 1. Quitar los encabezados no visibles ('TIMESTAMP' y 'CONSULTA')
                    // El 铆ndice 0 es TIMESTAMP, el 铆ndice 5 es CONSULTA
                    const consultaIndex = fullHeaders.findIndex(h => h === 'CONSULTA');
                    if (consultaIndex !== -1) {
                        fullHeaders.splice(consultaIndex, 1); // Quitar CONSULTA (F)
                    }
                    const timestampIndex = fullHeaders.findIndex(h => h === 'TIMESTAMP');
                    if (timestampIndex !== -1) {
                         fullHeaders.splice(timestampIndex, 1); // Quitar TIMESTAMP (A)
                    }

                    headers = fullHeaders; // B, C, D, E (Headers visibles)

                    // 2. Quitar la columna 'TIMESTAMP' y 'CONSULTA' de los datos que se van a renderizar (quedan B, C, D, E)
                    finalData = originalData.map(row => {
                         // originalRow tiene 6 columnas (A, B, C, D, E, F)
                         // Quitamos A (铆ndice 0) y F (铆ndice 5), quedando B, C, D, E (铆ndices 1, 2, 3, 4)
                        return row.slice(1, 5); 
                    });
                    // originalData sigue teniendo 6 columnas (A, B, C, D, E, F) para el modal de consulta

                } else {
                    // Otros casos 
                    headers = fullHeaders;
                    finalData = originalData;
                }
                
                // Guardamos los encabezados COMPLETOS (B-F para consulta, B-Q para afiliaci贸n)
                currentFullHeaders = fullHeaders;

                return { 
                    headers: headers, // Encabezados visibles
                    data: finalData, // Data visible
                    originalData: originalData, // Data completa
                    fullHeaders: currentFullHeaders // Todos los encabezados de datos (sin TIMESTAMP)
                };

            } catch (error) {
                console.error("Error al parsear el JSON de Google Sheets (GViz):", error);
                return { headers: [], data: [], originalData: [], fullHeaders: [] };
            }
        }

        /**
         * Renderiza la tabla con las columnas visibles, agregando data-attributes con el contenido completo.
         */
        function renderDataTable(headers, data, originalData, fullHeaders) {
            if (data.length === 0) {
                tableContainer.innerHTML = '<p class="text-center py-8 text-gray-500">No hay datos disponibles en esta hoja.</p>';
                return;
            }

            const sheetName = lastActiveSheet;
            
            // Si es 'tabla_consulta' o 'afiliacion', las filas son cliqueables.
            const isClickable = sheetName === 'tabla_consulta' || sheetName === 'afiliacion';
            const clickHandler = isClickable ? 'onclick="showModal(this)"' : '';
            const rowCursor = isClickable ? 'cursor-pointer' : '';

            let html = `
                <div class="rounded-xl overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto max-h-[70vh]">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                            <thead class="bg-indigo-600 text-white sticky top-0">
                                <tr>
                                    ${headers.map(header => `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">${header}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;

            // originalData siempre incluye el TIMESTAMP (columna A) en el 铆ndice 0.
            originalData.forEach((originalRow, index) => {
                const row = data[index]; // Solo las columnas visibles

                // --- PREPARAR DATA PARA EL MODAL ---
                let dataAttribute = '';

                if (sheetName === 'tabla_consulta') {
                    // originalRow tiene 6 columnas (A, B, C, D, E, F). F es el 铆ndice 5.
                    const consultaContent = originalRow.length > 5 ? originalRow[5] : 'N/A';
                    // Codificamos el contenido de la consulta
                    dataAttribute = `data-consulta="${encodeURIComponent(consultaContent)}"`;
                } else if (sheetName === 'afiliacion') {
                    // originalRow tiene TODAS las columnas (A-Q, 17 columnas). 
                    // fullHeaders tiene TODAS las columnas de datos (B-Q, 16 columnas).
                    
                    const rowObject = {};
                    
                    // Recorremos los fullHeaders (B-Q)
                    for (let i = 0; i < fullHeaders.length; i++) {
                        // El dato en originalRow est谩 en el 铆ndice i + 1 (porque el 铆ndice 0 es A=TIMESTAMP)
                        rowObject[fullHeaders[i]] = originalRow[i + 1];
                    }
                    
                    dataAttribute = `data-full-data="${encodeURIComponent(JSON.stringify(rowObject))}"`;
                }
                
                const rowClass = index % 2 === 0 ? 'bg-white hover:bg-indigo-50' : 'bg-gray-50 hover:bg-indigo-100';
                
                // Agregamos el handler de click y el atributo de data
                html += `<tr class="${rowClass} ${rowCursor}" ${clickHandler} ${dataAttribute}>`;
                html += row.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cell}</td>`).join('');
                html += `</tr>`;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            tableContainer.innerHTML = html;
        }

        async function loadSheetData(sheetName) {
            const gid = sheetGids[sheetName];
            if (!gid) return; 
            
            // --- CDIGO MODIFICADO AQU PARA CAMBIAR EL TTULO ---
            let displayTitle = '';
            if (sheetName === 'tabla_consulta') {
                displayTitle = 'Consultas realizadas';
            } else if (sheetName === 'afiliacion') {
                displayTitle = 'Afiliaciones solicitadas';
            } else {
                // T铆tulo por defecto si hay otro caso
                displayTitle = sheetName.charAt(0).toUpperCase() + sheetName.slice(1).replace('_', ' '); 
            }
            
            currentSheetTitle.textContent = displayTitle;
            // ----------------------------------------------------
            
            dataLoadingMessage.style.display = 'block';
            tableContainer.innerHTML = ''; 
            
            try {
                const response = await fetch(createGvizUrl(gid, sheetName));
                const text = await response.text();
                // Parseamos los datos, obteniendo las cabeceras completas tambi茅n
                const { headers, data, originalData, fullHeaders } = parseGvizData(text, sheetName);
                
                // Pasamos la data visible y la data original a renderDataTable
                renderDataTable(headers, data, originalData, fullHeaders);
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                dataLoadingMessage.textContent = `Error al cargar los datos: ${error.message}`;
            } finally {
                dataLoadingMessage.style.display = 'none';
            }
        }


        // --- NAVEGACIN Y CARGA INICIAL ---

        /**
         * Controla la visibilidad de la vista y la carga de datos.
         */
        function loadView(sheetName) {
            
            // 1. Manejo especial para el gestor de novedades (AHORA ABRE EN LA MISMA PESTAA)
            if (sheetName === 'gestor_novedades_external') {
                openGestorNovedades();
                // REDIRECCIN COMPLETA: Salimos de la funci贸n
                return; 
            }

            // 2. REDIRECCIN PARA CREDENCIAL_QR (AHORA ABRE EN LA MISMA PESTAA)
            if (sheetName === 'credencial_qr') {
                window.location.href = 'credencial_qr.html'; // Abre en la misma pesta帽a
                // REDIRECCIN COMPLETA: Salimos de la funci贸n
                return;
            }
            // ------------------------------------------------
            
            // 3. Cargar datos
            loadSheetData(sheetName);
            
            // 4. Actualizar el estado del 煤ltimo bot贸n activo
            lastActiveSheet = sheetName;

            // 5. Actualizar botones activos (solo los de las vistas de tabla)
            buttons.forEach(btn => {
                const btnSheet = btn.getAttribute('data-sheet');
                
                // Desactiva el estilo 'active-indigo' para todos
                btn.classList.remove('active-indigo');

                // Si es un bot贸n de vista de tabla y es el seleccionado, lo activa.
                if (btnSheet !== 'gestor_novedades_external' && btnSheet !== 'credencial_qr' && btnSheet === sheetName) {
                    btn.classList.add('active-indigo');
                }
            });
        }

        // Asignar listeners a los botones de navegaci贸n
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                loadView(button.getAttribute('data-sheet'));
            });
        });

        // Carga inicial
        document.addEventListener('DOMContentLoaded', () => {
            // Carga la vista de "Tabla Consulta" por defecto
            loadView('tabla_consulta');
        });

    </script>
</body>
</html>